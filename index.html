<!DOCTYPE html>
<html lang="en"> <!-- Default language set here -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVA Canteen</title> <!-- Updated Title -->
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* --- Theme Variables --- */
             /* Blue Theme (Original - Base) */
            --main-bg-color-blue: #48B4F6; --lighter-bg-blue: #6ADDEF; --button-bg-color-blue: #6ADDEF;
            --active-green-blue: #90EE90; --remove-red-blue: #FF6B6B; --pending-orange-blue: #FFA500;
            --delivered-green-blue: #32CD32; --preparing-yellow-blue: #FFD700; --text-color-dark-blue: #000;
            --text-color-light-blue: #fff; --border-color-blue: #000;
            --body-outer-bg-blue: #282828;

            /* Green Theme (Refined) */
            --main-bg-color-green: #4CAF50;    /* Slightly richer green */
            --lighter-bg-green: #81C784;      /* Softer light green */
            --button-bg-color-green: #81C784;
            --active-green-green: #FFEB3B;     /* Vibrant Yellow for contrast */
            --remove-red-green: #ef5350;       /* Slightly softer red */
            --pending-orange-green: #FFA726;   /* Clear Orange */
            --delivered-green-green: #66BB6A;  /* Complementary delivered green */
            --preparing-yellow-green: #FFEE58; /* Lighter preparing yellow */
            --text-color-dark-green: #000;     /* Black text mostly works */
            --text-color-light-green: #fff;
            --border-color-green: #2E7D32;     /* Darker green border */
            --body-outer-bg-green: #1B5E20;     /* Dark forest green */

            /* Purple Theme (Refined) */
            --main-bg-color-purple: #9C27B0;   /* Standard Material Purple */
            --lighter-bg-purple: #CE93D8;     /* Lighter lavender */
            --button-bg-color-purple: #CE93D8;
            --active-green-purple: #76FF03;    /* Bright Lime green active */
            --remove-red-purple: #F44336;      /* Standard Material Red */
            --pending-orange-purple: #FF9800;  /* Standard Material Orange */
            --delivered-green-purple: #4CAF50; /* Standard Material Green */
            --preparing-yellow-purple: #FFEB3B;/* Standard Material Yellow */
            --text-color-dark-purple: #000;    /* Black text */
            --text-color-light-purple: #fff;   /* White text */
            --border-color-purple: #4A148C;    /* Deep purple border */
            --body-outer-bg-purple: #311B92;    /* Deep indigo/purple outer */

            /* Theme 1: White & Blue (Light Blue) */
            --main-bg-color-light-blue: #ffffff; --lighter-bg-light-blue: #E3F2FD; --button-bg-color-light-blue: #E3F2FD;
            --active-green-light-blue: #66BB6A; --remove-red-light-blue: #EF5350; --pending-orange-light-blue: #FFA726;
            --delivered-green-light-blue: #4CAF50; --preparing-yellow-light-blue: #FFEE58; --text-color-dark-light-blue: #0D47A1; /* Dark Blue Text */
            --text-color-light-light-blue: #0D47A1; /* Dark Blue Text for buttons */ --border-color-light-blue: #90A4AE; /* Blue Grey Border */
            --body-outer-bg-light-blue: #ECEFF1; /* Very Light Grey Outer */
            /* Colors for Light Blue Swatch */
            --swatch-light-blue-1: #ffffff;
            --swatch-light-blue-2: #90CAF9; /* A visible light blue */

            /* Theme 2: White & Black (Monochrome Light) */
            --main-bg-color-mono-light: #ffffff; --lighter-bg-mono-light: #f5f5f5; --button-bg-color-mono-light: #f5f5f5;
            --active-green-mono-light: #4CAF50; --remove-red-mono-light: #f44336; --pending-orange-mono-light: #ff9800;
            --delivered-green-mono-light: #8BC34A; --preparing-yellow-mono-light: #FFEB3B; --text-color-dark-mono-light: #000000; /* Black Text */
            --text-color-light-mono-light: #000000; /* Black Text for buttons */ --border-color-mono-light: #000000; /* Black Border */
            --body-outer-bg-mono-light: #e0e0e0; /* Light Grey Outer */
            /* Colors for Monochrome Light Swatch */
            --swatch-mono-light-1: #ffffff;
            --swatch-mono-light-2: #000000;

            /* Theme 3: Dark Grey (Refined Dark) */
            --main-bg-color-dark-grey: #37474F; --lighter-bg-dark-grey: #546E7A; --button-bg-color-dark-grey: #546E7A;
            --active-green-dark-grey: #80CBC4; --remove-red-dark-grey: #EF9A9A; --pending-orange-dark-grey: #FFCC80;
            --delivered-green-dark-grey: #A5D6A7; --preparing-yellow-dark-grey: #FFF59D; --text-color-dark-dark-grey: #ECEFF1; /* Light Text */
            --text-color-light-dark-grey: #ffffff; /* White Text Title */ --border-color-dark-grey: #78909C; /* Lighter Grey Border */
            --body-outer-bg-dark-grey: #263238; /* Very Dark Grey Outer */

            /* Theme 4: Dark Blue (Night) */
            --main-bg-color-night: #0d1b2a; --lighter-bg-night: #1b263b; --button-bg-color-night: #1b263b;
            --active-green-night: #00A896; --remove-red-night: #D00000; --pending-orange-night: #FF8C00;
            --delivered-green-night: #007F5F; --preparing-yellow-night: #FFBA08; --text-color-dark-night: #E0E1DD; /* Off-white text */
            --text-color-light-night: #FFFFFF; /* White Text Title */ --border-color-night: #415a77; /* Mid Blue Border */
            --body-outer-bg-night: #03071e; /* Almost Black Outer */

            /* Theme 5: Black & White (Monochrome Dark) */
            --main-bg-color-mono-dark: #000000;         /* Black background */
            --lighter-bg-mono-dark: #212121;          /* Dark grey for elements */
            --button-bg-color-mono-dark: #212121;
            --active-green-mono-dark: #ffffff;         /* White for active/highlight */
            --remove-red-mono-dark: #bdbdbd;           /* Medium grey for remove */
            --pending-orange-mono-dark: #9e9e9e;       /* Darker grey for pending */
            --delivered-green-mono-dark: #ffffff;      /* White for delivered status button */
            --preparing-yellow-mono-dark: #ffffff;     /* White for preparing status button */
            --text-color-dark-mono-dark: #f5f5f5;      /* Very light grey text */
            --text-color-light-mono-dark: #ffffff;     /* White text for titles/buttons */
            --border-color-mono-dark: #757575;         /* Mid-grey border */
            --body-outer-bg-mono-dark: #121212;         /* Very dark grey outer bg */
            /* Colors for Monochrome Dark Swatch */
            --swatch-mono-dark-1: #000000;
            --swatch-mono-dark-2: #ffffff;

            /* ADDED: Theme 6: Yellow */
            --main-bg-color-yellow: #FFC107;   /* Bright Yellow */
            --lighter-bg-yellow: #FFD54F;    /* Lighter Yellow */
            --button-bg-color-yellow: #FFD54F;
            --active-green-yellow: #7CB342;   /* Lime Green */
            --remove-red-yellow: #F4511E;     /* Deep Orange/Red */
            --pending-orange-yellow: #FB8C00;  /* Orange */
            --delivered-green-yellow: #558B2F; /* Darker Lime Green */
            --preparing-yellow-yellow: #FFEE58;/* Light Yellow */
            --text-color-dark-yellow: #212121; /* Very Dark Grey/Black */
            --text-color-light-yellow: #000000;/* Black */
            --border-color-yellow: #FFA000;   /* Amber */
            --body-outer-bg-yellow: #F57F17;   /* Darker Yellow/Orange */
            /* Colors for Yellow Swatch */
            --swatch-yellow-1: #FFC107;
            --swatch-yellow-2: #FFA000;

            /* ADDED: Theme 7: Orange */
            --main-bg-color-orange: #FF9800;   /* Material Orange */
            --lighter-bg-orange: #FFB74D;    /* Lighter Orange */
            --button-bg-color-orange: #FFB74D;
            --active-green-orange: #AED581;   /* Light Green */
            --remove-red-orange: #E57373;     /* Light Red */
            --pending-orange-orange: #FFB74D;  /* Lighter Orange for contrast */
            --delivered-green-orange: #81C784; /* Complementary Green */
            --preparing-yellow-orange: #FFF176; /* Light Yellow */
            --text-color-dark-orange: #000000; /* Black */
            --text-color-light-orange: #FFFFFF;/* White */
            --border-color-orange: #F57C00;   /* Darker Orange */
            --body-outer-bg-orange: #E65100;   /* Deep Orange */
            /* Colors for Orange Swatch */
            --swatch-orange-1: #FF9800;
            --swatch-orange-2: #F57C00;


             /* Aliases - Initially Point to Blue Theme */
            --main-bg-color: var(--main-bg-color-blue); --lighter-blue-bg: var(--lighter-bg-blue); --button-bg-color: var(--button-bg-color-blue);
            --active-green: var(--active-green-blue); --remove-red: var(--remove-red-blue); --pending-orange: var(--pending-orange-blue);
            --delivered-green: var(--delivered-green-blue); --preparing-yellow: var(--preparing-yellow-blue); --text-color-dark: var(--text-color-dark-blue);
            --text-color-light: var(--text-color-light-blue); --border-color: var(--border-color-blue);
            --body-outer-bg: var(--body-outer-bg-blue); /* Alias for outer bg */

            /* Sizes & Radii */
            --screen-min-height: 600px; --screen-border-radius: 35px; --element-border-radius: 10px;
            --pill-border-radius: 50px; --border-thickness: 2px;
            /* Transitions */
            --transition-speed: 0.3s; --fast-transition-speed: 0.15s; --view-change-speed: 0.4s;
            --lang-change-speed: 0.3s;
            /* Fonts */
            --font-en: 'Nunito', sans-serif; --font-ar: 'Cairo', sans-serif;

            /* FIXED Status Colors (Independent of theme) */
            --status-pending-bg: #FFA500;  /* Orange */
            --status-pending-text: #000000; /* Black */
            --status-preparing-bg: #FFD700; /* Gold */
            --status-preparing-text: #000000;/* Black */
            --status-delivered-bg: #32CD32; /* LimeGreen */
            --status-delivered-text: #ffffff;/* White */
        }

        /* Apply Aliases based on theme attribute */
        body[data-theme="green"] {
            --main-bg-color: var(--main-bg-color-green); --lighter-blue-bg: var(--lighter-bg-green); --button-bg-color: var(--button-bg-color-green);
            --active-green: var(--active-green-green); --remove-red: var(--remove-red-green); --pending-orange: var(--pending-orange-green);
            --delivered-green: var(--delivered-green-green); --preparing-yellow: var(--preparing-yellow-green); --text-color-dark: var(--text-color-dark-green);
            --text-color-light: var(--text-color-light-green); --border-color: var(--border-color-green);
            --body-outer-bg: var(--body-outer-bg-green);
        }
        body[data-theme="purple"] {
            --main-bg-color: var(--main-bg-color-purple); --lighter-blue-bg: var(--lighter-bg-purple); --button-bg-color: var(--button-bg-color-purple);
            --active-green: var(--active-green-purple); --remove-red: var(--remove-red-purple); --pending-orange: var(--pending-orange-purple);
            --delivered-green: var(--delivered-green-purple); --preparing-yellow: var(--preparing-yellow-purple); --text-color-dark: var(--text-color-dark-purple);
            --text-color-light: var(--text-color-light-purple); --border-color: var(--border-color-purple);
            --body-outer-bg: var(--body-outer-bg-purple);
        }
         body[data-theme="light-blue"] {
            --main-bg-color: var(--main-bg-color-light-blue); --lighter-blue-bg: var(--lighter-bg-light-blue); --button-bg-color: var(--button-bg-color-light-blue);
            --active-green: var(--active-green-light-blue); --remove-red: var(--remove-red-light-blue); --pending-orange: var(--pending-orange-light-blue);
            --delivered-green: var(--delivered-green-light-blue); --preparing-yellow: var(--preparing-yellow-light-blue); --text-color-dark: var(--text-color-dark-light-blue);
            --text-color-light: var(--text-color-light-light-blue); --border-color: var(--border-color-light-blue);
            --body-outer-bg: var(--body-outer-bg-light-blue);
        }
        body[data-theme="mono-light"] {
            --main-bg-color: var(--main-bg-color-mono-light); --lighter-blue-bg: var(--lighter-bg-mono-light); --button-bg-color: var(--button-bg-color-mono-light);
            --active-green: var(--active-green-mono-light); --remove-red: var(--remove-red-mono-light); --pending-orange: var(--pending-orange-mono-light);
            --delivered-green: var(--delivered-green-mono-light); --preparing-yellow: var(--preparing-yellow-mono-light); --text-color-dark: var(--text-color-dark-mono-light);
            --text-color-light: var(--text-color-light-mono-light); --border-color: var(--border-color-mono-light);
            --body-outer-bg: var(--body-outer-bg-mono-light);
        }
        body[data-theme="dark-grey"] {
            --main-bg-color: var(--main-bg-color-dark-grey); --lighter-blue-bg: var(--lighter-bg-dark-grey); --button-bg-color: var(--button-bg-color-dark-grey);
            --active-green: var(--active-green-dark-grey); --remove-red: var(--remove-red-dark-grey); --pending-orange: var(--pending-orange-dark-grey);
            --delivered-green: var(--delivered-green-dark-grey); --preparing-yellow: var(--preparing-yellow-dark-grey); --text-color-dark: var(--text-color-dark-dark-grey);
            --text-color-light: var(--text-color-light-dark-grey); --border-color: var(--border-color-dark-grey);
            --body-outer-bg: var(--body-outer-bg-dark-grey);
        }
        body[data-theme="night"] {
            --main-bg-color: var(--main-bg-color-night); --lighter-blue-bg: var(--lighter-bg-night); --button-bg-color: var(--button-bg-color-night);
            --active-green: var(--active-green-night); --remove-red: var(--remove-red-night); --pending-orange: var(--pending-orange-night);
            --delivered-green: var(--delivered-green-night); --preparing-yellow: var(--preparing-yellow-night); --text-color-dark: var(--text-color-dark-night);
            --text-color-light: var(--text-color-light-night); --border-color: var(--border-color-night);
            --body-outer-bg: var(--body-outer-bg-night);
        }
        body[data-theme="mono-dark"] {
            --main-bg-color: var(--main-bg-color-mono-dark); --lighter-blue-bg: var(--lighter-bg-mono-dark); --button-bg-color: var(--button-bg-color-mono-dark);
            --active-green: var(--active-green-mono-dark); --remove-red: var(--remove-red-mono-dark); --pending-orange: var(--pending-orange-mono-dark);
            --delivered-green: var(--delivered-green-mono-dark); --preparing-yellow: var(--preparing-yellow-mono-dark); --text-color-dark: var(--text-color-dark-mono-dark);
            --text-color-light: var(--text-color-light-mono-dark); --border-color: var(--border-color-mono-dark);
            --body-outer-bg: var(--body-outer-bg-mono-dark);
        }
        /* ADDED: Yellow Theme Application */
        body[data-theme="yellow"] {
            --main-bg-color: var(--main-bg-color-yellow); --lighter-blue-bg: var(--lighter-bg-yellow); --button-bg-color: var(--button-bg-color-yellow);
            --active-green: var(--active-green-yellow); --remove-red: var(--remove-red-yellow); --pending-orange: var(--pending-orange-yellow);
            --delivered-green: var(--delivered-green-yellow); --preparing-yellow: var(--preparing-yellow-yellow); --text-color-dark: var(--text-color-dark-yellow);
            --text-color-light: var(--text-color-light-yellow); --border-color: var(--border-color-yellow);
            --body-outer-bg: var(--body-outer-bg-yellow);
        }
        /* ADDED: Orange Theme Application */
        body[data-theme="orange"] {
            --main-bg-color: var(--main-bg-color-orange); --lighter-blue-bg: var(--lighter-bg-orange); --button-bg-color: var(--button-bg-color-orange);
            --active-green: var(--active-green-orange); --remove-red: var(--remove-red-orange); --pending-orange: var(--pending-orange-orange);
            --delivered-green: var(--delivered-green-orange); --preparing-yellow: var(--preparing-yellow-orange); --text-color-dark: var(--text-color-dark-orange);
            --text-color-light: var(--text-color-light-orange); --border-color: var(--border-color-orange);
            --body-outer-bg: var(--body-outer-bg-orange);
        }


        html { font-size: 16px; scroll-behavior: smooth; height: 100%; box-sizing: border-box; }
        *, *:before, *:after { box-sizing: inherit; }

        /* DEFAULT BODY STYLES (LTR) */
        body {
            background-color: var(--body-outer-bg); /* Use theme variable */
            display: flex; justify-content: center; align-items: flex-start; padding: 20px 10px; font-family: var(--font-en); margin: 0; min-height: 100vh; overflow-x: hidden;
            transition: padding var(--view-change-speed) ease, background-color var(--view-change-speed) ease;
            direction: ltr;
        }

        /* --- START: Arabic (RTL) Styles --- */
        html[lang="ar"] body { direction: rtl; font-family: var(--font-ar); }
        html[lang="ar"] .header { flex-direction: row-reverse; } html[lang="ar"] .header-button i { margin-right: 8px; margin-left: 0; }
        html[lang="ar"] .cart-badge { left: -5px; right: auto; } html[lang="ar"] .menu-item { text-align: right; }
        html[lang="ar"] .cart-item { flex-direction: row-reverse; }
        html[lang="ar"] .item-details { margin-left: 30px; margin-right: 10px; }
        html[lang="ar"] .item-info { flex-direction: row-reverse; order: 2; }
        html[lang="ar"] .item-info p { text-align: right; }
        html[lang="ar"] .item-price-button { margin-right: auto; margin-left: 0; order: 1; }
        html[lang="ar"] .payment-button i { margin-left: 8px; margin-right: 0; } html[lang="ar"] .search-section { flex-direction: row-reverse; }
        html[lang="ar"] .order-id { text-align: right; }
        html[lang="ar"] .order-total { text-align: left; }
        html[lang="ar"] .order-preview-content p { text-align: right; }
        html[lang="ar"] .order-preview-content ul { padding-left: 0; padding-right: 15px; } html[lang="ar"] .order-status-controls { flex-direction: row-reverse; flex-wrap: wrap-reverse; }
        html[lang="ar"] .status-button i { margin-left: 8px; margin-right: 0; }
        html[lang="ar"] .add-to-cart-preview-button i { margin-left: 10px !important; margin-right: 0 !important; }
        html[lang="ar"] input[type="email"], html[lang="ar"] input[type="password"], html[lang="ar"] input[type="text"] { text-align: right; } html[lang="ar"] input::placeholder { text-align: right; }
        html[lang="ar"] .logout-button i, html[lang="ar"] .back-button i, html[lang="ar"] .item-preview-container .header-button i, html[lang="ar"] #screen-8 .header-button i { transform: scaleX(-1); }
        html[lang="ar"] #discover-button i { margin-left: 8px; margin-right: 0; }
        html[lang="ar"] h2, html[lang="ar"] h4, html[lang="ar"] .screen-title, html[lang="ar"] .preview-name, html[lang="ar"] .preview-description, html[lang="ar"] .empty-cart-message, html[lang="ar"] .no-orders-message, html[lang="ar"] .order-preview-placeholder, html[lang="ar"] .error-message, html[lang="ar"] .sort-options p, html[lang="ar"] .payment-label, html[lang="ar"] .switch-account p, html[lang="ar"] .pick-photo-label, html[lang="ar"] #screen-1 .form-box h3, html[lang="ar"] #screen-2 .form-box h3,
        html[lang="ar"] .order-status, html[lang="ar"] .discovery-section h4 { text-align: center !important; }
        /* RTL Settings Panel Content */
        /* REMOVED: RTL override for settings panel position */ html[lang="ar"] #settings-panel { font-family: var(--font-ar); /* LTR rules apply now */ }
        html[lang="ar"] .settings-label { text-align: right; }
        html[lang="ar"] .settings-current-display span:first-child:not(.theme-swatch):not(.toggle-switch) { text-align: right; }
        html[lang="ar"] .option-item { text-align: right; flex-direction: row-reverse; }
        html[lang="ar"] .option-item span:first-of-type:not(.theme-swatch) { text-align: right; }
        html[lang="ar"] .theme-swatch { }
        /* RTL Discovery Mode */
        html[lang="ar"] .offer-card h5 { text-align: right; }
        html[lang="ar"] .offer-card p.offer-description { text-align: right; }
        html[lang="ar"] .offer-items span { margin-left: 6px; margin-right: 0; }
        html[lang="ar"] .bundle-pricing { flex-direction: row-reverse; }
        html[lang="ar"] .add-bundle-button i, html[lang="ar"] .add-suggestion-button i { margin-left: 8px; margin-right: 0; }
        html[lang="ar"] .bundle-discount-tag { left: 10px; right: auto; transform: rotate(-5deg); }
        html[lang="ar"] .discovery-offers-scroller { direction: rtl; }
        html[lang="ar"] .suggestion-grid-item h5 { text-align: center !important; }
        html[lang="ar"] .suggestion-total-price strong { margin-left: 5px; margin-right: 0; }
        html[lang="ar"] .discovery-category-section h5 { text-align: right; }
        html[lang="ar"] .discovery-category-grid { direction: rtl; }
        html[lang="ar"] .discovery-category-item p { text-align: right; }
        /* RTL Suggestion Item Images */
        html[lang="ar"] .suggestion-item-images { flex-direction: row-reverse; }
        html[lang="ar"] .suggestion-item-images .plus-separator { margin: 0 5px; } /* Ensure spacing is consistent */

        /* REMOVED: RTL Sort Actions Container */
        /* RTL: Settings Toggle */
        html[lang="ar"] .settings-toggle { margin-left: auto; margin-right: 0; }
        html[lang="ar"] .toggle-switch { left: auto; right: 2px; }
        html[lang="ar"] .settings-toggle[aria-checked="true"] .toggle-switch { transform: translateX(-18px); }
        html[lang="ar"] #discovery-toggle-group .settings-label { text-align: right; }
        /* RTL Passcode Modal */
        html[lang="ar"] .passcode-modal-buttons { flex-direction: row-reverse; }


        /* --- END: Arabic (RTL) Styles --- */

        /* App Container */
        .app-container {
            width: 100%; max-width: 340px; min-height: var(--screen-min-height); position: relative; overflow: hidden;
            border-radius: var(--screen-border-radius); border: var(--border-thickness) solid var(--border-color);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); background-color: var(--main-bg-color);
            margin: 0 auto;
            transition: max-width var(--view-change-speed) ease, min-height var(--view-change-speed) ease, height var(--view-change-speed) ease, width var(--view-change-speed) ease, margin var(--view-change-speed) ease, border-radius var(--view-change-speed) ease, border var(--view-change-speed) ease, box-shadow var(--view-change-speed) ease, opacity var(--lang-change-speed) ease-in-out, background-color var(--view-change-speed) ease;
        }
        .app-container.language-switching { opacity: 0; pointer-events: none; }

        /* Full Screen Mode */
        body.full-screen-mode {
            padding: 0;
            background-color: var(--body-outer-bg);
            align-items: stretch; overflow: hidden; height: 100%;
        }
        body.full-screen-mode .app-container { max-width: none; margin: 0; border: none; border-radius: 0; box-shadow: none; width: 100%; height: 100%; min-height: 100%; }

         /* Base Screen Styling */
        .screen {
            width: 100%; height: 100%; padding: 25px 20px; box-sizing: border-box;
            display: flex; flex-direction: column;
            position: absolute; top: 0; left: 0;
            opacity: 0; pointer-events: none;
            transform: translateY(40px);
            overflow-y: auto; z-index: 1;
            background-color: var(--main-bg-color);
            transition: opacity var(--transition-speed) ease-in-out,
                        transform calc(var(--transition-speed) * 1.5) cubic-bezier(0.175, 0.885, 0.32, 1.275),
                        background-color var(--view-change-speed) ease;
        }

        /* Active Screen Style */
        .screen.active {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
            z-index: 2;
        }

        /* Screen Content Base Style */
        .screen-content {
            display: flex; flex-direction: column; align-items: center;
            width: 100%; flex-grow: 1; max-width: 1100px;
            margin-left: auto; margin-right: auto; padding-bottom: 70px;
        }

        /* General Styles (Headings, Forms, Buttons, etc.) */
        h2 { color: var(--text-color-light); -webkit-text-stroke: 1px var(--text-color-dark); text-stroke: 1px var(--text-color-dark); paint-order: stroke fill; font-size: 2rem; margin-bottom: 25px; text-align: center; font-weight: 700; }
        h3:not(.screen-title) { color: var(--text-color-dark); font-size: 1.3rem; margin-bottom: 20px; text-align: center; }
        h4 { color: var(--text-color-light); -webkit-text-stroke: 1px var(--text-color-dark); text-stroke: 1px var(--text-color-dark); paint-order: stroke fill; font-size: 1.8rem; margin-top: 10px; margin-bottom: 20px; text-align: center; font-weight: 700; }
        #screen-5 h4 { font-size: 1.5rem; margin-bottom: 10px; color: var(--text-color-dark); -webkit-text-stroke: none; text-stroke: none; text-align: center; }
        .form-box { width: 100%; margin-bottom: 25px; display: flex; flex-direction: column; align-items: center; max-width: 450px; }
        #screen-1 .form-box h3, #screen-2 .form-box h3 { font-size: 1.5rem; text-align: center; }
        input[type="email"], input[type="password"], input[type="text"] { background-color: var(--lighter-blue-bg); border: var(--border-thickness) solid var(--border-color); border-radius: var(--element-border-radius); padding: 12px 15px; margin-bottom: 15px; width: 100%; box-sizing: border-box; color: var(--text-color-dark); font-size: 1rem; transition: box-shadow var(--fast-transition-speed) ease, background-color var(--view-change-speed) ease, border-color var(--view-change-speed) ease; text-align: left; }
        input:focus { outline: none; box-shadow: 0 0 0 2px var(--active-green); }
        input::placeholder { color: #555; text-align: left; }
         body[data-theme="yellow"] input::placeholder, body[data-theme="orange"] input::placeholder { color: #777; }
        .error-message { color: red; font-size: 0.9rem; display: none; margin-top: -10px; margin-bottom: 10px; text-align: center; }
        .button { border: var(--border-thickness) solid var(--border-color); border-radius: var(--pill-border-radius); padding: 10px 25px; cursor: pointer; font-size: 1.1rem; font-weight: 600; text-align: center; background-color: var(--lighter-blue-bg); color: var(--text-color-dark); transition: background-color var(--fast-transition-speed) ease, transform var(--fast-transition-speed) ease, border-color var(--view-change-speed) ease, color var(--view-change-speed) ease; width: 70%; margin-top: 15px; box-sizing: border-box; user-select: none; max-width: 350px; font-family: inherit; }
        .button:hover:not(:active) { background-color: color-mix(in srgb, var(--lighter-blue-bg) 80%, white); }
        .button:active { transform: scale(0.96); background-color: color-mix(in srgb, var(--lighter-blue-bg) 60%, white); }
        .button.rect-button { border-radius: var(--element-border-radius); width: 100%; } .button.submit-button { width: auto; padding: 10px 35px; margin-top: 25px; font-size: 1.2rem; }
        .button.small-button { font-size: 0.9rem; padding: 6px 15px; width: auto; margin-top: 5px; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .button.small-button i { font-size: 1em; }
        .button.back-button { width: auto; padding: 8px 20px; font-size: 0.9rem; margin-top: 25px; background: transparent; border: none; color: var(--text-color-dark); display: inline-flex; align-items: center; gap: 5px; }
        body[data-theme="light-blue"] .button.back-button, body[data-theme="mono-light"] .button.back-button { color: #555; }
        body[data-theme="dark-grey"] .button.back-button, body[data-theme="night"] .button.back-button, body[data-theme="mono-dark"] .button.back-button { color: #ccc; }
         body[data-theme="yellow"] .button.back-button, body[data-theme="orange"] .button.back-button { color: var(--text-color-dark); }
        .switch-account { margin-top: 40px; text-align: center; width: 80%; max-width: 350px; } .switch-account p { font-size: 0.9rem; color: var(--text-color-dark); margin-bottom: 8px; text-align: center; }
        .pick-photo-label { font-size: 1.1rem; color: var(--text-color-dark); margin-top: 20px; margin-bottom: 15px; font-weight: 600; text-align: center; }
        .photo-picker { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
        .profile-pic { width: 70px; height: 70px; border-radius: 50%; border: 3px solid transparent; cursor: pointer; object-fit: cover; transition: border-color var(--transition-speed) ease, transform var(--fast-transition-speed) ease; background-color: #eee; }
        .profile-pic:active { transform: scale(0.95); } .profile-pic.active { border-color: var(--border-color); transform: scale(1.05); }

        /* Header (General) */
        .header { display: flex; align-items: center; justify-content: space-between; width: 100%; margin-bottom: 30px; padding: 0; position: relative; min-height: 60px; gap: 10px; }
        .header h3.screen-title { flex-grow: 1; text-align: center; margin: 0; font-size: 1.8rem; color: var(--text-color-light); -webkit-text-stroke: 1px var(--text-color-dark); text-stroke: 1px var(--text-color-dark); paint-order: stroke fill; font-weight: 700; }
        .header-button { margin-top: 0; flex-shrink: 0; background: var(--lighter-blue-bg); border: var(--border-thickness) solid var(--border-color); border-radius: var(--element-border-radius); padding: 8px 12px; cursor: pointer; font-size: 0.9rem; font-weight: 600; color: var(--text-color-dark); display: flex; align-items: center; gap: 8px; white-space: nowrap; transition: background-color var(--fast-transition-speed) ease, transform var(--fast-transition-speed) ease, border-color var(--view-change-speed) ease, color var(--view-change-speed) ease; user-select: none; font-family: inherit; }
        .header-button:active { transform: scale(0.96); background-color: color-mix(in srgb, var(--lighter-blue-bg) 60%, white); }
        .header-button i { font-size: 1.1em; margin-left: 8px; }


        /* Cart & User Icons */
        .cart-icon-container, .user-icon-container { margin-top: 0; flex-shrink: 0; position: relative; display: flex; flex-direction: column; align-items: center; gap: 3px; min-width: 50px; cursor: pointer; user-select: none; transition: transform var(--fast-transition-speed) ease; }
        .cart-icon-container:active, .user-icon-container:active { transform: scale(0.95); }
        .cart-icon, .user-icon { width: 45px; height: 45px; border-radius: 50%; border: var(--border-thickness) solid var(--border-color); background-color: var(--lighter-blue-bg); display: flex; justify-content: center; align-items: center; font-size: 1.6rem; color: var(--text-color-dark); transition: background-color var(--fast-transition-speed) ease, border-color var(--view-change-speed) ease, color var(--view-change-speed) ease; overflow: hidden; }
        .user-icon img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; display: none; } .user-icon i.fa-user { display: block; }
        .cart-icon-container:hover .cart-icon, .user-icon-container:hover .user-icon { background-color: color-mix(in srgb, var(--lighter-blue-bg) 80%, white); }
        .cart-icon-container span, .user-icon-container span { font-size: 0.8rem; font-weight: 600; color: var(--text-color-dark); transition: color var(--view-change-speed) ease;}
        .cart-badge { position: absolute; top: -5px; right: -5px; background-color: var(--active-green); color: var(--text-color-light); border-radius: 50%; width: 22px; height: 22px; font-size: 0.8rem; font-weight: 700; display: none; justify-content: center; align-items: center; border: 1px solid var(--border-color); transform-origin: center; animation: pulseBadge 1.5s infinite ease-in-out; transition: background-color var(--view-change-speed) ease, color var(--view-change-speed) ease, border-color var(--view-change-speed) ease, opacity 0.2s ease; }
        body[data-theme="green"] .cart-badge, body[data-theme="yellow"] .cart-badge, body[data-theme="orange"] .cart-badge { color: var(--text-color-dark); }
         body[data-theme="blue"] #cart-badge, body[data-theme="blue"] #cart-badge-preview, body[data-theme="blue"] #cart-badge-discovery { color: #000; }
        .cart-badge.visible { display: flex; } @keyframes pulseBadge { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* Menu Styles */
        /* MODIFIED: Restore .sort-options original position & margin */
        .sort-options {
            display: flex; flex-direction: column; align-items: center; width: 100%;
            margin-bottom: 25px; /* Restore original bottom margin */
        }
        /* REMOVED: sort-actions-container */
        .sort-options p { margin: 0 0 10px 0; font-size: 1.2rem; font-weight: 600; color: var(--text-color-dark); text-align: center; transition: color var(--view-change-speed) ease;}
        .sort-buttons { display: flex; gap: 10px; border: var(--border-thickness) solid var(--border-color); border-radius: var(--pill-border-radius); padding: 5px; background-color: rgba(255, 255, 255, 0.2); flex-wrap: wrap; justify-content: center; transition: border-color var(--view-change-speed) ease;}
        .sort-button { background: none; border: none; border-radius: var(--pill-border-radius); padding: 6px 18px; cursor: pointer; font-size: 1rem; font-weight: 600; color: var(--text-color-dark); transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease, transform var(--fast-transition-speed) ease; user-select: none; margin: 2px; font-family: inherit; }
        .sort-button.active { background-color: var(--active-green); color: var(--text-color-dark); } .sort-button:active { transform: scale(0.96); }
        body[data-theme="green"] .sort-button.active, body[data-theme="yellow"] .sort-button.active, body[data-theme="orange"] .sort-button.active { color: var(--text-color-dark); }

        /* MODIFIED: Style for Discover Button below Sort Options */
        #discover-button {
             margin-top: -5px; /* Adjust spacing between sort and discover */
             margin-bottom: 20px; /* Space below discover button */
             /* Inherits .button and .small-button styles */
             background-color: #ffeb3b;
             border-color: #fbc02d;
             color: #000;
             display: none; /* Initially hidden */
             width: auto; /* Let content determine width */
        }
        #discover-button:hover:not(:active) { background-color: #fff06b; }

        .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 100%; padding-bottom: 10px; }
        @keyframes fadeInItem { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .menu-item { background-color: var(--main-bg-color); border: var(--border-thickness) solid var(--border-color); border-radius: var(--element-border-radius); padding: 10px; text-align: center; flex-direction: column; align-items: center; justify-content: space-between; box-sizing: border-box; cursor: pointer; transition: transform var(--fast-transition-speed) ease, box-shadow var(--fast-transition-speed) ease, background-color var(--view-change-speed) ease, border-color var(--view-change-speed) ease; opacity: 1; animation: fadeInItem 0.5s ease-out backwards; display: flex; }
        .menu-item.hidden { display: none; } .menu-item:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); } .menu-item:active { transform: scale(0.98) translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .menu-item img { width: 100%; aspect-ratio: 4 / 3; object-fit: cover; border-radius: 5px; margin-bottom: 10px; border: 1px solid rgba(0,0,0,0.1); background-color: #eee; pointer-events: none; }
        .menu-item p { margin: 0 0 10px 0; font-size: 1rem; font-weight: 600; color: var(--text-color-dark); pointer-events: none; text-align: center; transition: color var(--view-change-speed) ease;}
        .menu-item .price-button { background-color: var(--button-bg-color); border: var(--border-thickness) solid var(--border-color); border-radius: var(--pill-border-radius); padding: 5px 15px; font-size: 0.9rem; font-weight: 700; color: var(--text-color-dark); display: inline-block; transition: background-color var(--fast-transition-speed) ease, transform var(--fast-transition-speed) ease, border-color var(--view-change-speed) ease, color var(--view-change-speed) ease; pointer-events: auto; user-select: none; z-index: 5; position: relative; font-family: inherit; }
        .menu-item .price-button:active { transform: scale(0.95); background-color: color-mix(in srgb, var(--button-bg-color) 60%, white); }

        /* Cart Styles */
        .cart-items { width: 100%; margin-bottom: 25px; display: flex; flex-direction: column; gap: 15px; min-height: 100px; max-width: 600px; margin-left: auto; margin-right: auto; }
        .cart-item { display: flex; align-items: center; background-color: var(--main-bg-color); border: var(--border-thickness) solid var(--border-color); border-radius: var(--element-border-radius); padding: 10px; gap: 10px; animation: fadeInItem 0.5s ease-out backwards; position: relative; transition: background-color var(--view-change-speed) ease, border-color var(--view-change-speed) ease;}
        .cart-item.discount-item { background-color: color-mix(in srgb, var(--active-green) 10%, var(--main-bg-color)); }
        .cart-item img { width: 65px; height: 65px; border-radius: 5px; object-fit: cover; border: 1px solid rgba(0,0,0,0.1); background-color: #eee; flex-shrink: 0; }
        .item-details { flex-grow: 1; display: flex; align-items: center; gap: 10px; flex-wrap: nowrap; margin-right: 30px; overflow: hidden; }
        .item-info { display: flex; flex-direction: row; align-items: baseline; gap: 8px; flex-grow: 1; flex-shrink: 1; overflow: hidden; min-width: 0; order: 1; }
        .item-info p { margin: 0; font-size: 1rem; font-weight: 700; color: var(--text-color-dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-shrink: 1; min-width: 0; text-align: left; transition: color var(--view-change-speed) ease;}
        span.item-quantity { font-size: 0.9rem; font-weight: 600; color: var(--text-color-dark); margin: 0; white-space: nowrap; flex-shrink: 0; transition: color var(--view-change-speed) ease;}
        .item-price-button { background-color: var(--button-bg-color); border: var(--border-thickness) solid var(--border-color); border-radius: var(--pill-border-radius); padding: 6px 12px; font-size: 0.9rem; font-weight: 700; color: var(--text-color-dark); white-space: nowrap; margin-left: auto; flex-shrink: 0; font-family: inherit; order: 2; transition: background-color var(--view-change-speed) ease, border-color var(--view-change-speed) ease, color var(--view-change-speed) ease;}
        .remove-item-button { position: absolute; top: 5px; right: 5px; background: var(--remove-red); color: white; border: 1px solid var(--border-color); border-radius: 50%; width: 20px; height: 20px; font-size: 0.8rem; line-height: 18px; text-align: center; cursor: pointer; font-weight: bold; transition: background-color var(--fast-transition-speed) ease, transform var(--fast-transition-speed) ease, border-color var(--view-change-speed) ease; }
        body[data-theme="dark-grey"] .remove-item-button, body[data-theme="orange"] .remove-item-button { color: var(--text-color-dark); }
        .remove-item-button:hover { background-color: color-mix(in srgb, var(--remove-red) 80%, black); } .remove-item-button:active { transform: scale(0.9); }
        .cart-total { padding-top: 15px; width: 100%; margin-top: auto; display: flex; flex-direction: column; align-items: center; gap: 8px; max-width: 600px; margin-left: auto; margin-right: auto; }
        .cart-total h4 { font-size: 1.5rem; margin-bottom: 5px; color: var(--text-color-dark); text-stroke: none; -webkit-text-stroke: none; text-align: center; transition: color var(--view-change-speed) ease;}
        .total-calculation { text-align: center; width: 100%; font-size: 0.9rem; color: var(--text-color-dark); line-height: 1.4; max-height: 80px; overflow-y: auto; padding: 0 5px; transition: color var(--view-change-speed) ease;}
        .total-calculation p { margin: 2px 0; font-weight: 600;}
        span.final-equals { font-size: 1.3rem; font-weight: 700; color: var(--text-color-dark); margin-top: 5px; transition: color var(--view-change-speed) ease;}
        .total-amount-button { background-color: var(--button-bg-color); border: var(--border-thickness) solid var(--border-color); border-radius: var(--pill-border-radius); padding: 8px 25px; font-size: 1.2rem; font-weight: 700; color: var(--text-color-dark); display: inline-block; cursor: pointer; transition: background-color var(--fast-transition-speed) ease, transform var(--fast-transition-speed) ease, border-color var(--view-change-speed) ease, color var(--view-change-speed) ease; user-select: none; font-family: inherit; }
        .total-amount-button:active { transform: scale(0.96); background-color: color-mix(in srgb, var(--button-bg-color) 60%, white); }
        .empty-cart-message, .no-orders-message { color: var(--text-color-dark); font-weight: 600; margin: 20px 0; text-align: center; transition: color var(--view-change-speed) ease;}
        .payment-method-section { display: flex; flex-direction: column; align-items: center; width: 100%; margin-top: 15px; margin-bottom: 10px; }
        .payment-label { margin: 0 0 8px 0; font-size: 1.1rem; font-weight: 600; color: var(--text-color-dark); text-align: center; transition: color var(--view-change-speed) ease;}
        .payment-methods { display: flex; gap: 10px; border: var(--border-thickness) solid var(--border-color); border-radius: var(--pill-border-radius); padding: 5px; background-color: rgba(255, 255, 255, 0.2); flex-wrap: wrap; justify-content: center; transition: border-color var(--view-change-speed) ease;}
        .payment-button { display: flex; align-items: center; gap: 8px; padding: 6px 15px; margin: 2px; font-family: inherit; }
        body[data-theme="green"] .payment-button.active, body[data-theme="yellow"] .payment-button.active, body[data-theme="orange"] .payment-button.active { color: var(--text-color-dark); }
        .payment-button i { font-size: 1.1em; margin-right: 8px; }

        /* Management Screen */
        .management-container { display: flex; flex-direction: column; width: 100%; flex-grow: 1; gap: 20px; }
        .search-section { display: flex; gap: 10px; width: 100%; margin-bottom: 0; flex-wrap: wrap; }
        .search-section input { flex-grow: 1; margin-bottom: 0; min-width: 150px; }
        .search-section .button { width: auto; margin-top: 0; padding: 10px 15px; font-size: 1rem; border-radius: var(--element-border-radius); flex-shrink: 0; }
        .order-management-layout { display: flex; flex-direction: column; flex-grow: 1; gap: 15px; width: 100%; }
        .order-log-section { display: flex; flex-direction: column; width: 100%; }
        .order-log-container { max-height: 200px; overflow-y: auto; border: var(--border-thickness) solid var(--border-color); border-radius: var(--element-border-radius); padding: 10px; background-color: rgba(255, 255, 255, 0.1); display: flex; flex-direction: column; gap: 8px; transition: border-color var(--view-change-speed) ease;}
        .order-log-item { display: flex; justify-content: space-between; align-items: center; background-color: var(--lighter-blue-bg); border: var(--border-thickness) solid var(--border-color); border-radius: 5px; padding: 8px 12px; cursor: pointer; transition: background-color var(--fast-transition-speed), border-color var(--view-change-speed), color var(--view-change-speed); gap: 5px; }
        .order-log-item:hover { background-color: color-mix(in srgb, var(--lighter-blue-bg) 80%, white); }
        .order-log-item.active { background-color: var(--active-green); }
         body[data-theme="green"] .order-log-item.active, body[data-theme="yellow"] .order-log-item.active, body[data-theme="orange"] .order-log-item.active { color: var(--text-color-dark); }
         body[data-theme="green"] .order-log-item.active span, body[data-theme="yellow"] .order-log-item.active span, body[data-theme="orange"] .order-log-item.active span { color: inherit; }
        .order-log-item span { font-size: 0.9rem; font-weight: 600; white-space: nowrap; transition: color var(--view-change-speed) ease;}
        .order-id { flex-basis: 40%; overflow: hidden; text-overflow: ellipsis; flex-shrink: 1; text-align: left; color: var(--text-color-dark); }
        .order-total { flex-basis: 30%; text-align: right; flex-shrink: 0; color: var(--text-color-dark); }

        /* Order Status Styling */
        .order-status { flex-basis: 30%; text-align: center; text-transform: capitalize; padding: 3px 8px; border-radius: 4px; font-weight: 700; flex-shrink: 0; transition: background-color 0.2s ease, color 0.2s ease; border: 1px solid rgba(0,0,0,0.2); }
        .order-status.pending { background-color: var(--status-pending-bg); color: var(--status-pending-text); }
        .order-status.preparing { background-color: var(--status-preparing-bg); color: var(--status-preparing-text); }
        .order-status.delivered { background-color: var(--status-delivered-bg); color: var(--status-delivered-text); }

        .order-preview-section { display: flex; flex-direction: column; width: 100%; border: var(--border-thickness) solid var(--border-color); border-radius: var(--element-border-radius); padding: 15px; background-color: rgba(255, 255, 255, 0.1); min-height: 150px; transition: border-color var(--view-change-speed) ease;}
        .order-preview-content { font-size: 0.9rem; color: var(--text-color-dark); flex-grow: 1; text-align: left; transition: color var(--view-change-speed) ease;}
        .order-preview-content p { margin: 3px 0; font-weight: 600; } .order-preview-content p strong { margin-right: 5px; } html[lang="ar"] .order-preview-content p strong { margin-left: 5px; margin-right: 0; } .order-preview-content p span { font-weight: normal; }
        .order-preview-content ul { list-style: none; padding-left: 15px; margin: 5px 0; } .order-preview-content li { margin-bottom: 2px; font-size: 0.95em;}
        .order-preview-placeholder { text-align: center; color: #555; margin-top: 20px; transition: color var(--view-change-speed) ease;}
         body[data-theme="yellow"] .order-preview-placeholder, body[data-theme="orange"] .order-preview-placeholder { color: #888; }
        .order-status-controls { display: flex; gap: 10px; margin-top: 15px; justify-content: center; flex-wrap: wrap; }
        .status-button { font-family: inherit; } .status-button i { margin-right: 5px; } .status-button.active { background-color: var(--active-green); } .status-button:disabled { background-color: #ccc; cursor: not-allowed; border-color: #999; color: #666; }
         body[data-theme="green"] .status-button.active, body[data-theme="yellow"] .status-button.active, body[data-theme="orange"] .status-button.active { color: var(--text-color-dark); }


        /* Item Preview Screen */
        .item-preview-container { align-items: center; padding-top: 10px; }
        .preview-image { width: 80%; max-width: 220px; height: auto; aspect-ratio: 4 / 3; object-fit: cover; border-radius: var(--element-border-radius); border: var(--border-thickness) solid var(--border-color); margin-bottom: 20px; background-color: #eee; box-shadow: 0 3px 8px rgba(0,0,0,0.15); transition: border-color var(--view-change-speed) ease;}
        .preview-name { font-size: 1.7rem; color: var(--text-color-dark); font-weight: 700; margin-bottom: 10px; text-align: center; transition: color var(--view-change-speed) ease;}
        .preview-description { font-size: 0.95rem; color: var(--text-color-dark); text-align: center; margin-bottom: 20px; margin-top: 0; padding: 0 10px; width: 95%; line-height: 1.4; max-width: 500px; transition: color var(--view-change-speed) ease;}
        .preview-price { font-size: 1.3rem; font-weight: 700; color: var(--text-color-dark); margin-bottom: 30px; background-color: var(--button-bg-color); padding: 6px 20px; border-radius: var(--pill-border-radius); border: var(--border-thickness) solid var(--border-color); display: inline-block; font-family: inherit; transition: background-color var(--view-change-speed) ease, border-color var(--view-change-speed) ease, color var(--view-change-speed) ease;}
        .add-to-cart-preview-button { width: 80%; max-width: 240px; margin-top: auto; margin-bottom: 15px; padding: 12px 20px; font-size: 1.2rem; display: flex; justify-content: center; align-items: center; gap: 10px; background-color: var(--active-green); border-color: var(--border-color); color: var(--text-color-dark); font-family: inherit; transition: background-color var(--fast-transition-speed) ease, transform var(--fast-transition-speed) ease, border-color var(--view-change-speed) ease, color var(--view-change-speed) ease;}
        body[data-theme="green"] .add-to-cart-preview-button, body[data-theme="yellow"] .add-to-cart-preview-button, body[data-theme="orange"] .add-to-cart-preview-button { color: var(--text-color-dark); }
         body[data-theme="yellow"] .add-to-cart-preview-button.added { background-color: var(--pending-orange-yellow); color: var(--text-color-dark-yellow); }
         body[data-theme="yellow"] .add-to-cart-preview-button.added:hover:not(:active) { background-color: color-mix(in srgb, var(--pending-orange-yellow) 80%, white); }
         body[data-theme="orange"] .add-to-cart-preview-button.added { background-color: var(--pending-orange-orange); color: var(--text-color-dark-orange); }
         body[data-theme="orange"] .add-to-cart-preview-button.added:hover:not(:active) { background-color: color-mix(in srgb, var(--pending-orange-orange) 80%, white); }
        .add-to-cart-preview-button i { margin-right: 10px !important; margin-left: 0 !important; }
        .add-to-cart-preview-button:hover:not(:active) { background-color: color-mix(in srgb, var(--active-green) 80%, white); }
        .add-to-cart-preview-button:active { transform: scale(0.96); background-color: color-mix(in srgb, var(--active-green) 60%, white); }
        .add-to-cart-preview-button.added { background-color: var(--pending-orange); cursor: pointer; color: var(--text-color-dark); }
        .add-to-cart-preview-button.added:hover:not(:active) { background-color: color-mix(in srgb, var(--pending-orange) 80%, white); }


        /* --- Floating Settings Panel Styles --- */
        #settings-panel { position: fixed; bottom: 65px; right: 15px; width: 280px; background-color: #4a4a4a; color: #e0e0e0; border-radius: 12px; padding: 15px 20px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4); z-index: 1100; font-family: var(--font-en); border: 1px solid #666; visibility: hidden; opacity: 0; transform: translateY(15px) scale(0.95); transform-origin: bottom right; transition: visibility 0.25s ease-out, opacity 0.25s ease-out, transform 0.25s ease-out; }
        /* REMOVED: RTL override for settings panel position */ html[lang="ar"] #settings-panel { font-family: var(--font-ar); /* LTR rules apply now */ }
        #settings-panel.visible { visibility: visible; opacity: 1; transform: translateY(0) scale(1); }
        /* MODIFIED: Added flex back for toggle group */
        .settings-group { margin-bottom: 15px; position: relative; }
        #discovery-toggle-group { display: flex; align-items: center; justify-content: space-between; } /* Apply flex only to toggle group */
        .settings-group:last-child { margin-bottom: 5px; }
        .settings-label { display: block; font-size: 0.9rem; font-weight: 600; color: #bbb; margin-bottom: 8px; text-align: left; flex-grow: 1; /* Allow label to grow in flex */ padding-right: 10px; /* Space before toggle */ }
        #discovery-toggle-group .settings-label { margin-bottom: 0; } /* Remove bottom margin for toggle label */
        html[lang="ar"] .settings-label { text-align: right; }
        html[lang="ar"] #discovery-toggle-group .settings-label { padding-left: 10px; padding-right: 0; }
        .settings-current-display { display: flex; align-items: center; gap: 10px; background-color: #5f5f5f; padding: 10px 12px; border-radius: 8px; cursor: pointer; border: 1px solid #777; transition: background-color 0.2s ease; outline: none; width: 100%; }
        .settings-current-display:hover, .settings-current-display:focus { background-color: #6a6a6a; }
        .settings-current-display span:first-child:not(.theme-swatch):not(.toggle-switch) { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: left; }
        html[lang="ar"] .settings-current-display span:first-child:not(.theme-swatch):not(.toggle-switch) { text-align: right; }
        .settings-current-display .fa-chevron-down { transition: transform 0.3s ease; font-size: 0.9em; color: #ccc; flex-shrink: 0; } .settings-group.open .settings-current-display .fa-chevron-down { transform: rotate(180deg); }
        .settings-options-list { position: absolute; background-color: #3a3a3a; border-radius: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); z-index: 1101; padding: 5px 0; width: 100%; left: 0; top: calc(100% + 5px); border: 1px solid #555; max-height: 0; overflow: hidden; opacity: 0; visibility: hidden; transition: max-height 0.25s ease-out, opacity 0.25s ease-out; }
        .settings-group.open-upward .settings-options-list { top: auto; bottom: calc(100% + 5px); }
        .settings-group.open .settings-options-list { max-height: 200px; opacity: 1; visibility: visible; overflow-y: auto; transition: max-height 0.25s ease-out, opacity 0.25s ease-out; z-index: 1102; }
        .option-item { display: flex; align-items: center; gap: 8px; padding: 10px 15px; cursor: pointer; color: #e0e0e0; transition: background-color 0.15s ease; text-align: left; } html[lang="ar"] .option-item { text-align: right; flex-direction: row-reverse; }
        .option-item:hover { background-color: #555; }
        .option-item span:first-of-type:not(.theme-swatch) { flex-grow: 1; text-align: left; } html[lang="ar"] .option-item span:first-of-type:not(.theme-swatch) { text-align: right; }
        .option-item .fa-check { display: none; color: #00bcd4; font-size: 0.9em; flex-shrink: 0; }
        .option-item.active .fa-check { display: inline-block; } .option-item.active { font-weight: 700; color: #fff; }
        .theme-swatch { display: inline-block; width: 18px; height: 18px; border-radius: 50%; border: 1px solid #888; flex-shrink: 0; vertical-align: middle; background-color: #ccc; }
        .swatch-blue { background-color: var(--main-bg-color-blue); } .swatch-green { background-color: var(--main-bg-color-green); } .swatch-purple { background-color: var(--main-bg-color-purple); } .swatch-dark-grey { background-color: var(--main-bg-color-dark-grey); } .swatch-night { background-color: var(--main-bg-color-night); }
        .swatch-light-blue { background: linear-gradient(to right, var(--swatch-light-blue-1) 0%, var(--swatch-light-blue-1) 50%, var(--swatch-light-blue-2) 50%, var(--swatch-light-blue-2) 100%); background-color: transparent; }
        .swatch-mono-light { background: linear-gradient(to right, var(--swatch-mono-light-1) 0%, var(--swatch-mono-light-1) 50%, var(--swatch-mono-light-2) 50%, var(--swatch-mono-light-2) 100%); background-color: transparent; }
        .swatch-mono-dark { background: linear-gradient(to right, var(--swatch-mono-dark-1) 0%, var(--swatch-mono-dark-1) 50%, var(--swatch-mono-dark-2) 50%, var(--swatch-mono-dark-2) 100%); background-color: transparent; }
        .swatch-yellow { background: linear-gradient(to right, var(--swatch-yellow-1) 0%, var(--swatch-yellow-1) 50%, var(--swatch-yellow-2) 50%, var(--swatch-yellow-2) 100%); background-color: transparent; }
        .swatch-orange { background: linear-gradient(to right, var(--swatch-orange-1) 0%, var(--swatch-orange-1) 50%, var(--swatch-orange-2) 50%, var(--swatch-orange-2) 100%); background-color: transparent; }

        /* RE-ADDED: Settings Toggle Switch Styles */
        .settings-toggle {
            position: relative;
            display: inline-block;
            width: 40px; height: 22px;
            background-color: #777; /* Background when off */
            border-radius: 11px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            flex-shrink: 0; /* Prevent shrinking */
        }
        .toggle-switch {
            position: absolute;
            top: 2px; left: 2px;
            width: 18px; height: 18px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }
        .settings-toggle[aria-checked="true"] { background-color: #4CAF50; }
        .settings-toggle[aria-checked="true"] .toggle-switch { transform: translateX(18px); }

        /* --- End Floating Settings Panel Styles --- */

        /* Order Preview Dark/Light Theme Text Color Fix */
        body[data-theme="dark-grey"] #order-preview-content, body[data-theme="night"] #order-preview-content, body[data-theme="mono-dark"] #order-preview-content { color: var(--text-color-dark); }
        body[data-theme="dark-grey"] #order-preview-content p, body[data-theme="dark-grey"] #order-preview-content li, body[data-theme="dark-grey"] #order-preview-content span, body[data-theme="dark-grey"] #order-preview-content strong, body[data-theme="night"] #order-preview-content p, body[data-theme="night"] #order-preview-content li, body[data-theme="night"] #order-preview-content span, body[data-theme="night"] #order-preview-content strong, body[data-theme="mono-dark"] #order-preview-content p, body[data-theme="mono-dark"] #order-preview-content li, body[data-theme="mono-dark"] #order-preview-content span, body[data-theme="mono-dark"] #order-preview-content strong { color: inherit; }
        body[data-theme="dark-grey"] .order-preview-placeholder, body[data-theme="night"] .order-preview-placeholder, body[data-theme="mono-dark"] .order-preview-placeholder { color: #90A4AE; }

        /* --- Custom Alert Modal Styles --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 100; visibility: hidden; opacity: 0; display: flex; justify-content: center; align-items: center; padding: 20px; transition: opacity var(--transition-speed) ease, visibility var(--transition-speed) ease; font-family: var(--font-en); }
        html[lang="ar"] .modal-overlay { font-family: var(--font-ar); } .modal-overlay.visible { visibility: visible; opacity: 1; }
        .modal-box { background-color: #E0F7FA; padding: 25px 30px; border-radius: var(--element-border-radius); border: var(--border-thickness) solid #0077B6; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-width: 90%; width: 320px; text-align: center; color: #111; transform: scale(0.9); opacity: 0; transition: transform var(--transition-speed) ease, opacity var(--transition-speed) ease; will-change: transform, opacity; }
        .modal-overlay.visible .modal-box { transform: scale(1); opacity: 1; }
        .modal-box h3 { font-size: 1.4rem; margin-top: 0; margin-bottom: 15px; color: #000; font-weight: 700; -webkit-text-stroke: 0; text-stroke: 0; }
        .modal-box p { margin-bottom: 25px; line-height: 1.6; font-size: 1rem; font-weight: 600; white-space: pre-line; color: #333; }
        html[lang="ar"] .modal-box h3, html[lang="ar"] .modal-box p { text-align: right !important; } html[lang="en"] .modal-box h3, html[lang="en"] .modal-box p { text-align: left !important; }
        .modal-box .button { width: auto; padding: 8px 35px; margin-top: 10px; font-size: 1.1rem; background-color: var(--button-bg-color); border: var(--border-thickness) solid var(--border-color); color: var(--text-color-dark); border-radius: var(--pill-border-radius); transition: background-color var(--fast-transition-speed) ease, transform var(--fast-transition-speed) ease, border-color var(--fast-transition-speed) ease, color var(--fast-transition-speed) ease; }
        .modal-box .button:hover { background-color: color-mix(in srgb, var(--button-bg-color) 80%, white); border-color: color-mix(in srgb, var(--border-color) 80%, white); }
        .modal-box .button:active { transform: scale(0.96); background-color: color-mix(in srgb, var(--button-bg-color) 60%, white); }
        body[data-theme="dark-grey"] #custom-alert-box, body[data-theme="night"] #custom-alert-box, body[data-theme="mono-dark"] #custom-alert-box { background-color: #424242; color: #eee; border-color: #616161; }
        body[data-theme="dark-grey"] #custom-alert-box h3, body[data-theme="night"] #custom-alert-box h3, body[data-theme="mono-dark"] #custom-alert-box h3 { color: #fff; -webkit-text-stroke: 0; text-stroke: 0; }
        body[data-theme="dark-grey"] #custom-alert-box p, body[data-theme="night"] #custom-alert-box p, body[data-theme="mono-dark"] #custom-alert-box p { color: #ddd; }
        /* --- End Custom Alert Modal Styles --- */

        /* --- Passcode Modal Styles (Settings Theme) --- */
        #passcode-modal-overlay {
            z-index: 1200; /* Above settings panel */
            font-family: var(--font-en); /* Base font */
        }
        html[lang="ar"] #passcode-modal-overlay { font-family: var(--font-ar); }

        #passcode-modal-box {
            /* Base modal appearance matching Settings Panel */
            background-color: #4a4a4a;
            border: 1px solid #666;
            color: #e0e0e0;
            width: 290px;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            /* Other modal properties */
            max-width: 90%;
            text-align: center;
            transform: scale(0.9);
            opacity: 0;
            transition: transform var(--transition-speed) ease, opacity var(--transition-speed) ease;
            will-change: transform, opacity;
         }
        .modal-overlay.visible #passcode-modal-box {
            transform: scale(1);
            opacity: 1;
        }

        #passcode-modal-box h3 {
             color: #e0e0e0; /* Light text */
             font-size: 1.2rem;
             margin-top: 0; /* Reset margin */
             margin-bottom: 15px;
             text-align: center !important;
             font-weight: 600;
             -webkit-text-stroke: 0;
             text-stroke: 0;
         }

        #passcode-modal-box input[type="password"] {
             width: 100%;
             padding: 10px 15px;
             margin-bottom: 20px;
             text-align: center;
             font-size: 1.1rem;
             background-color: #5f5f5f; /* Settings interactive bg */
             color: #e0e0e0; /* Light text */
             border: 1px solid #777; /* Settings interactive border */
             border-radius: 8px; /* Settings interactive radius */
             box-sizing: border-box;
         }
         #passcode-modal-box input[type="password"]:focus {
             outline: none;
             box-shadow: 0 0 0 2px #00bcd4; /* Settings focus */
         }
         #passcode-modal-box input::placeholder {
            color: #aaa;
            text-align: center;
         }
         html[lang="ar"] #passcode-modal-box input::placeholder {
            text-align: center;
         }

         #passcode-modal-box .error-message {
             font-size: 0.85rem;
             margin-top: -15px;
             margin-bottom: 15px;
             color: #EF9A9A; /* Settings-like error red */
             display: none;
             text-align: center !important;
         }

        .passcode-modal-buttons {
             display: flex;
             justify-content: space-between;
             align-items: center;
             gap: 15px;
             margin-top: 15px;
         }

        /* General button style inside passcode modal (Settings Theme) */
        #passcode-modal-box .button {
             margin-top: 0;
             padding: 10px 15px;
             font-size: 1rem;
             font-weight: 700;
             background-color: #5f5f5f; /* Settings interactive bg */
             border: 1px solid #777; /* Settings interactive border */
             color: #e0e0e0; /* Light text */
             transition: background-color var(--fast-transition-speed) ease, transform var(--fast-transition-speed) ease;
             cursor: pointer;
             user-select: none;
             font-family: inherit;
         }
         #passcode-modal-box .button:hover:not(:active) {
             background-color: #6a6a6a; /* Settings hover */
         }
         #passcode-modal-box .button:active {
             transform: scale(0.96);
             background-color: #555; /* Settings active */
         }

         /* Specific styles for Cancel button */
         #passcode-modal-box .button.cancel-button {
             flex-grow: 1;
             border-radius: 8px; /* Match settings dropdown radius */
             text-align: center;
         }

         /* Specific styles for OK button */
         #passcode-modal-box .button.ok-button {
             width: 55px;
             height: 55px;
             border-radius: 50%;
             padding: 0;
             flex-shrink: 0;
             line-height: calc(55px - 2 * 1px);
             font-size: 1.1rem;
         }
        /* --- End Passcode Modal Styles --- */


        /* --- START: Fixes for Monochrome Dark Text Visibility --- */
        body[data-theme="mono-dark"] .cart-badge { color: var(--main-bg-color-mono-dark); border-color: var(--text-color-dark-mono-dark); }
        body[data-theme="mono-dark"] .add-to-cart-preview-button { color: var(--main-bg-color-mono-dark); }
        body[data-theme="mono-dark"] .add-to-cart-preview-button:hover:not(:active) { background-color: #e0e0e0; color: var(--main-bg-color-mono-dark); }
         body[data-theme="mono-dark"] .add-to-cart-preview-button.added { color: var(--main-bg-color-mono-dark); background-color: var(--pending-orange-mono-dark); }
         body[data-theme="mono-dark"] .add-to-cart-preview-button.added:hover:not(:active) { background-color: color-mix(in srgb, var(--pending-orange-mono-dark) 80%, white); color: var(--main-bg-color-mono-dark); }
        body[data-theme="mono-dark"] .sort-button.active, body[data-theme="mono-dark"] .payment-button.active { color: var(--main-bg-color-mono-dark); }
         body[data-theme="mono-dark"] .status-button.active { color: var(--main-bg-color-mono-dark); }
         body[data-theme="mono-dark"] .order-log-item.active { color: var(--main-bg-color-mono-dark); }
         body[data-theme="mono-dark"] .order-log-item.active span:not(.order-status) { color: inherit; }
        body[data-theme="mono-dark"] #goto-admin-login-button { color: #000000 !important; border-color: #000000; }
        body[data-theme="mono-dark"] #goto-admin-login-button:hover { color: #000000 !important; background-color: #ffda63 !important; }
        body[data-theme="mono-dark"] #discover-button { color: #000000 !important; border-color: #000000; }
        body[data-theme="mono-dark"] #discover-button:hover { color: #000000 !important; background-color: #ffda63 !important; }
        body[data-theme="mono-dark"] .remove-item-button { background-color: var(--remove-red-mono-dark); color: var(--main-bg-color-mono-dark); border-color: var(--text-color-dark-mono-dark); }
        body[data-theme="mono-dark"] .remove-item-button:hover { background-color: color-mix(in srgb, var(--remove-red-mono-dark) 80%, black); }
         /* REMOVED Passcode modal theme overrides as it's now fixed */
        /* --- END: Fixes for Monochrome Dark Text Visibility --- */

        /* Management/Discover Button Text Color Fix for Yellow/Orange Theme */
        body[data-theme="yellow"] #goto-admin-login-button, body[data-theme="orange"] #goto-admin-login-button, body[data-theme="yellow"] #discover-button, body[data-theme="orange"] #discover-button { color: #000 !important; }
        body[data-theme="yellow"] #goto-admin-login-button:hover, body[data-theme="orange"] #goto-admin-login-button:hover, body[data-theme="yellow"] #discover-button:hover, body[data-theme="orange"] #discover-button:hover { color: #000 !important; }
         /* REMOVED Passcode modal theme overrides as it's now fixed */


        /* Fixed Buttons Positioning Update & RTL */
        .fixed-button { position: fixed; bottom: 15px; z-index: 1000; background-color: rgba(0, 0, 0, 0.5); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; padding: 0; cursor: pointer; font-size: 1.1rem; line-height: 40px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.3); transition: background-color 0.2s ease, transform 0.2s ease; user-select: none; }
        .fixed-button:hover { background-color: rgba(0, 0, 0, 0.7); transform: scale(1.1); } .fixed-button:active { transform: scale(0.95); }
        #toggle-fullscreen-btn { right: 15px; left: auto; }
        #settings-btn { right: 65px; left: auto; font-size: 1.2rem; }
        /* REMOVED RTL Overrides for fixed button horizontal positioning */
        @media print { #toggle-fullscreen-btn, #settings-btn { display: none; } }

        /* Discovery Mode Styles */
        #screen-8 .screen-content { gap: 45px; }
        .discovery-section { width: 100%; background-color: transparent; border: none; border-radius: 0; padding: 0; }
        .discovery-section h4 { font-size: 1.5rem; margin-top: 0; margin-bottom: 20px; color: var(--text-color-dark); -webkit-text-stroke: none; text-stroke: none; text-align: center; border-bottom: 2px solid var(--border-color); padding-bottom: 12px; font-weight: 700; }
        body[data-theme="light-blue"] .discovery-section h4, body[data-theme="mono-light"] .discovery-section h4, body[data-theme="yellow"] .discovery-section h4, body[data-theme="orange"] .discovery-section h4 { color: var(--text-color-dark); border-bottom-color: color-mix(in srgb, var(--border-color) 80%, transparent); }
        body[data-theme="dark-grey"] .discovery-section h4, body[data-theme="night"] .discovery-section h4, body[data-theme="mono-dark"] .discovery-section h4 { color: var(--text-color-light); border-bottom-color: color-mix(in srgb, var(--border-color) 70%, transparent); }
        .discovery-offers-scroller { display: flex; overflow-x: auto; padding: 10px 5px 20px 5px; gap: 20px; scrollbar-width: thin; scrollbar-color: rgba(0,0,0,0.2) transparent; margin: 0 -20px; padding-left: 20px; padding-right: 20px; scroll-snap-type: x mandatory; }
        html[lang="ar"] .discovery-offers-scroller { direction: rtl; }
        .discovery-offers-scroller::-webkit-scrollbar { height: 8px; } .discovery-offers-scroller::-webkit-scrollbar-track { background: transparent; } .discovery-offers-scroller::-webkit-scrollbar-thumb { background-color: rgba(0, 0, 0, 0.25); border-radius: 10px; }
        body[data-theme="dark-grey"] .discovery-offers-scroller::-webkit-scrollbar-thumb, body[data-theme="night"] .discovery-offers-scroller::-webkit-scrollbar-thumb, body[data-theme="mono-dark"] .discovery-offers-scroller::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.25); }
        .offer-card { flex: 0 0 85%; max-width: 320px; background: linear-gradient(135deg, color-mix(in srgb, var(--lighter-blue-bg) 95%, black 5%), color-mix(in srgb, var(--main-bg-color) 80%, black 10%)); border: var(--border-thickness) solid var(--border-color); border-radius: 15px; padding: 18px; transition: background-color var(--view-change-speed) ease, border-color var(--view-change-speed) ease, box-shadow var(--fast-transition-speed) ease, background var(--view-change-speed) ease; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.12); display: flex; flex-direction: column; scroll-snap-align: center; }
        body[data-theme="mono-light"] .offer-card { background: linear-gradient(135deg, #fff, #eee); }
        body[data-theme="mono-dark"] .offer-card { background: linear-gradient(135deg, #333, #1a1a1a); }
        body[data-theme="light-blue"] .offer-card { background: linear-gradient(135deg, #F8FBFF, #E3F2FD); }
        .offer-card:hover { box-shadow: 0 8px 20px rgba(0,0,0,0.18); transform: translateY(-2px); }
        .offer-card h5 { margin: 0 0 12px 0; font-size: 1.25rem; font-weight: 700; color: var(--text-color-dark); transition: color var(--view-change-speed) ease; line-height: 1.3; }
        .offer-image-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 15px; max-height: 120px; overflow: hidden; }
        .offer-image-grid.count-1 { grid-template-columns: 1fr; max-height: 80px; } .offer-image-grid.count-3 { grid-template-columns: repeat(3, 1fr); max-height: 60px; } .offer-image-grid.count-4 { grid-template-columns: repeat(2, 1fr); }
        /* Image fade effect ONLY for bundles - STRONGER FADE */
        .offer-image-grid img {
            width: 100%;
            aspect-ratio: 4 / 3;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid rgba(0,0,0,0.1);
            background-color: #eee;
            /* Changed from 75% to 60% */
            -webkit-mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
            mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
        }
        .offer-card p.offer-description { margin: 0 0 15px 0; font-size: 0.9rem; color: var(--text-color-dark); line-height: 1.5; transition: color var(--view-change-speed) ease; }
        .offer-card .offer-items { margin-bottom: 15px; font-size: 0.9rem; color: var(--text-color-dark); font-weight: 600; transition: color var(--view-change-speed) ease; line-height: 1.6; }
        .offer-card .offer-items span { display: inline-block; background-color: color-mix(in srgb, var(--button-bg-color) 70%, #000000 5%); padding: 3px 9px; border-radius: var(--pill-border-radius); margin-right: 6px; margin-bottom: 6px; font-weight: 600; border: 1px solid color-mix(in srgb, var(--border-color) 60%, transparent); transition: background-color var(--view-change-speed) ease, border-color var(--view-change-speed) ease, color var(--view-change-speed) ease; }
        body[data-theme="light-blue"] .offer-items span, body[data-theme="mono-light"] .offer-items span, body[data-theme="yellow"] .offer-items span, body[data-theme="orange"] .offer-items span { color: var(--text-color-dark); }
        body[data-theme="dark-grey"] .offer-items span, body[data-theme="night"] .offer-items span, body[data-theme="mono-dark"] .offer-items span { color: var(--text-color-dark); background-color: color-mix(in srgb, var(--button-bg-color) 70%, #ffffff 5%); }
        .offer-actions { margin-top: auto; padding-top: 12px; border-top: 1px solid color-mix(in srgb, var(--border-color) 50%, transparent); }
        .bundle-pricing { display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        .bundle-original-price { font-size: 0.9rem; color: var(--remove-red); text-decoration: line-through; font-weight: 600; }
        .bundle-final-price { font-size: 1.15rem; font-weight: 700; color: var(--active-green); padding: 4px 10px; background-color: color-mix(in srgb, var(--active-green) 15%, transparent); border-radius: var(--element-border-radius); }
        body[data-theme="green"] .bundle-final-price, body[data-theme="yellow"] .bundle-final-price, body[data-theme="orange"] .bundle-final-price { color: var(--text-color-dark); background-color: color-mix(in srgb, var(--active-green) 80%, white); }
        body[data-theme="mono-dark"] .bundle-final-price { color: var(--main-bg-color-mono-dark); background-color: color-mix(in srgb, var(--active-green) 80%, black); }
        body[data-theme="dark-grey"] .bundle-original-price, body[data-theme="orange"] .bundle-original-price { color: #ef9a9a; }
        body[data-theme="mono-dark"] .bundle-original-price { color: var(--remove-red-mono-dark); }
        .add-bundle-button, .add-suggestion-button { display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; margin-top: 0; padding: 10px 15px; font-size: 1rem; font-weight: 700; border-color: var(--border-color); border-radius: var(--element-border-radius); border: var(--border-thickness) solid var(--border-color); cursor: pointer; text-align: center; transition: background-color var(--fast-transition-speed) ease, transform var(--fast-transition-speed) ease, border-color var(--view-change-speed) ease, color var(--view-change-speed) ease; user-select: none; font-family: inherit; }
         .add-bundle-button { background-color: var(--active-green); color: var(--text-color-dark); }
        .add-suggestion-button { background-color: var(--button-bg-color); color: var(--text-color-dark); }
        .add-suggestion-button:hover:not(:active) { background-color: color-mix(in srgb, var(--button-bg-color) 80%, white); }
        .add-bundle-button:hover:not(:active) { background-color: color-mix(in srgb, var(--active-green) 80%, white); }
        .add-bundle-button:active, .add-suggestion-button:active { transform: scale(0.96); }
        body[data-theme="green"] .add-bundle-button, body[data-theme="green"] .add-suggestion-button, body[data-theme="yellow"] .add-bundle-button, body[data-theme="yellow"] .add-suggestion-button, body[data-theme="orange"] .add-bundle-button, body[data-theme="orange"] .add-suggestion-button { color: var(--text-color-dark); }
        body[data-theme="mono-dark"] .add-bundle-button, body[data-theme="mono-dark"] .add-suggestion-button { color: var(--main-bg-color-mono-dark); }
        body[data-theme="mono-dark"] .add-suggestion-button { background-color: var(--button-bg-color-mono-dark); }
        .add-bundle-button.added, .add-suggestion-button.added { background-color: var(--pending-orange); color: var(--text-color-dark); }
        body[data-theme="yellow"] .add-bundle-button.added, body[data-theme="yellow"] .add-suggestion-button.added { background-color: var(--pending-orange-yellow); color: var(--text-color-dark-yellow); }
        body[data-theme="orange"] .add-bundle-button.added, body[data-theme="orange"] .add-suggestion-button.added { background-color: var(--pending-orange-orange); color: var(--text-color-dark-orange); }
        body[data-theme="mono-dark"] .add-bundle-button.added, body[data-theme="mono-dark"] .add-suggestion-button.added { background-color: var(--pending-orange-mono-dark); color: var(--main-bg-color-mono-dark); }
        .bundle-discount-tag { position: absolute; top: -10px; right: 10px; background-color: var(--remove-red); color: white; padding: 3px 8px; font-size: 0.8rem; font-weight: 700; border-radius: var(--pill-border-radius); transform: rotate(5deg); border: 1px solid var(--border-color); box-shadow: 1px 1px 3px rgba(0,0,0,0.2); z-index: 1; }
        body[data-theme="dark-grey"] .bundle-discount-tag, body[data-theme="orange"] .bundle-discount-tag { color: var(--text-color-dark); }
        body[data-theme="mono-dark"] .bundle-discount-tag { background-color: var(--remove-red-mono-dark); color: var(--main-bg-color-mono-dark); border-color: var(--text-color-dark-mono-dark); }
        .discovery-suggestions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 20px; }
        @media (min-width: 600px) { .discovery-suggestions-grid { grid-template-columns: repeat(auto-fit, minmax(210px, 1fr)); } }
        .suggestion-grid-item { background-color: var(--main-bg-color); border: var(--border-thickness) solid var(--border-color); border-radius: var(--element-border-radius); padding: 15px; display: flex; flex-direction: column; transition: transform var(--fast-transition-speed) ease, box-shadow var(--fast-transition-speed) ease, background-color var(--view-change-speed) ease, border-color var(--view-change-speed) ease; box-shadow: 0 2px 6px rgba(0,0,0,0.08); position: relative; }
        .suggestion-grid-item:hover { transform: translateY(-3px); box-shadow: 0 5px 12px rgba(0,0,0,0.12); }
        /* Suggestion Item Images Container */
        .suggestion-item-images {
             display: flex;
             align-items: center;
             justify-content: center;
             gap: 5px; /* Controls spacing between image/plus */
             margin-bottom: 15px; /* Space below images */
             flex-wrap: wrap; /* Allow wrapping if too many items */
             min-height: 50px; /* Increased */
         }
         /* Individual images within the suggestion */
         .suggestion-item-images img {
             width: 45px; /* Increased */
             height: 45px; /* Increased */
             border-radius: 50%;
             object-fit: cover;
             border: 1px solid color-mix(in srgb, var(--border-color) 50%, transparent);
             background-color: #eee; /* Fallback bg */
         }
         /* Plus separator style */
         .suggestion-item-images .plus-separator {
             font-size: 1.3rem; /* Increased */
             font-weight: 600;
             color: var(--text-color-dark);
             transition: color var(--view-change-speed) ease;
             padding: 0 2px; /* Small padding around plus */
         }
         body[data-theme="dark-grey"] .suggestion-item-images .plus-separator,
         body[data-theme="night"] .suggestion-item-images .plus-separator,
         body[data-theme="mono-dark"] .suggestion-item-images .plus-separator {
             color: var(--text-color-light);
         }

        .suggestion-grid-item h5 { margin: 0 0 10px 0; font-size: 1.15rem; font-weight: 700; color: var(--text-color-dark); text-align: center; transition: color var(--view-change-speed) ease; }
        .suggestion-grid-item .suggestion-items { margin-bottom: 15px; text-align: center; font-size: 0.9rem; line-height: 1.7; flex-grow: 1; }
        .suggestion-grid-item .suggestion-items span { display: inline-block; background-color: color-mix(in srgb, var(--button-bg-color) 70%, #000000 5%); padding: 3px 9px; border-radius: var(--pill-border-radius); margin: 3px; font-weight: 600; color: var(--text-color-dark); border: 1px solid color-mix(in srgb, var(--border-color) 60%, transparent); transition: background-color var(--view-change-speed) ease, border-color var(--view-change-speed) ease, color var(--view-change-speed) ease; }
        body[data-theme="light-blue"] .suggestion-items span, body[data-theme="mono-light"] .suggestion-items span, body[data-theme="yellow"] .suggestion-items span, body[data-theme="orange"] .suggestion-items span { color: var(--text-color-dark); }
        body[data-theme="dark-grey"] .suggestion-items span, body[data-theme="night"] .suggestion-items span, body[data-theme="mono-dark"] .suggestion-items span { color: var(--text-color-dark); background-color: color-mix(in srgb, var(--button-bg-color) 70%, #ffffff 5%); }
        .suggestion-total-price { font-size: 1rem; font-weight: 700; color: var(--text-color-dark); text-align: center; margin-bottom: 15px; padding-top: 10px; border-top: 1px dashed color-mix(in srgb, var(--border-color) 50%, transparent); transition: color var(--view-change-speed) ease; }
        .suggestion-total-price strong { margin-right: 5px; } html[lang="ar"] .suggestion-total-price strong { margin-left: 5px; margin-right: 0; }
        body[data-theme="dark-grey"] .suggestion-total-price, body[data-theme="night"] .suggestion-total-price, body[data-theme="mono-dark"] .suggestion-total-price { color: var(--text-color-light); }
        .suggestion-grid-item .add-suggestion-button { margin-top: auto; padding: 10px 15px; }
        .discovery-categories-container { width: 100%; display: flex; flex-direction: column; gap: 35px; }
        .discovery-category-section { width: 100%; }
        .discovery-category-section h5 { font-size: 1.4rem; color: var(--text-color-dark); margin: 0 0 18px 0; padding-bottom: 10px; border-bottom: 1px solid color-mix(in srgb, var(--border-color) 70%, transparent); font-weight: 700; text-align: left; transition: color var(--view-change-speed) ease, border-color var(--view-change-speed) ease; }
        html[lang="ar"] .discovery-category-section h5 { text-align: right; }
        body[data-theme="dark-grey"] .discovery-category-section h5, body[data-theme="night"] .discovery-category-section h5, body[data-theme="mono-dark"] .discovery-category-section h5 { color: var(--text-color-light); }
        .discovery-category-grid { display: flex; overflow-x: auto; padding-bottom: 15px; gap: 15px; scrollbar-width: thin; scrollbar-color: rgba(0,0,0,0.2) transparent; margin: 0 -15px; padding-left: 15px; padding-right: 15px; }
        html[lang="ar"] .discovery-category-grid { direction: rtl; }
        .discovery-category-grid::-webkit-scrollbar { height: 6px; } .discovery-category-grid::-webkit-scrollbar-track { background: transparent; } .discovery-category-grid::-webkit-scrollbar-thumb { background-color: rgba(0, 0, 0, 0.2); border-radius: 10px; }
        body[data-theme="dark-grey"] .discovery-category-grid::-webkit-scrollbar-thumb, body[data-theme="night"] .discovery-category-grid::-webkit-scrollbar-thumb, body[data-theme="mono-dark"] .discovery-category-grid::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.2); }
        .discovery-category-item { flex: 0 0 150px; background-color: var(--main-bg-color); border: var(--border-thickness) solid var(--border-color); border-radius: var(--element-border-radius); padding: 12px; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: space-between; box-sizing: border-box; cursor: pointer; transition: transform var(--fast-transition-speed) ease, box-shadow var(--fast-transition-speed) ease, background-color var(--view-change-speed) ease, border-color var(--view-change-speed) ease; }
        .discovery-category-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            /* border property removed */
        }
        .discovery-category-item:active { transform: scale(0.98) translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        /* Removed image fade from category items */
        .discovery-category-item img {
            width: 100%;
            aspect-ratio: 4 / 3;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 10px;
            border: 1px solid rgba(0,0,0,0.1);
            background-color: #eee;
            pointer-events: none;
            -webkit-mask-image: none;
            mask-image: none;
        }
        .discovery-category-item p { margin: 0 0 10px 0; font-size: 1rem; font-weight: 600; color: var(--text-color-dark); pointer-events: none; text-align: center; transition: color var(--view-change-speed) ease;}
        .discovery-category-item .price-button { background-color: var(--button-bg-color); border: var(--border-thickness) solid var(--border-color); border-radius: var(--pill-border-radius); padding: 5px 15px; font-size: 0.9rem; font-weight: 700; color: var(--text-color-dark); display: inline-block; transition: background-color var(--fast-transition-speed) ease, transform var(--fast-transition-speed) ease, border-color var(--view-change-speed) ease, color var(--view-change-speed) ease; pointer-events: auto; user-select: none; z-index: 5; position: relative; font-family: inherit; }
        .discovery-category-item .price-button:active { transform: scale(0.95); background-color: color-mix(in srgb, var(--button-bg-color) 60%, white); }

        /* Cart Badge Styles */
        #cart-badge-preview, #cart-badge-discovery { position: absolute; top: -5px; right: -5px; background-color: var(--active-green); color: var(--text-color-light); border-radius: 50%; width: 22px; height: 22px; font-size: 0.8rem; font-weight: 700; display: none; justify-content: center; align-items: center; border: 1px solid var(--border-color); transform-origin: center; animation: pulseBadge 1.5s infinite ease-in-out; transition: background-color var(--view-change-speed) ease, color var(--view-change-speed) ease, border-color var(--view-change-speed) ease, opacity 0.2s ease; }
         #cart-badge-preview.visible, #cart-badge-discovery.visible { display: flex; }
         html[lang="ar"] #cart-badge-preview, html[lang="ar"] #cart-badge-discovery { left: -5px; right: auto; }
         body[data-theme="green"] #cart-badge-preview, body[data-theme="green"] #cart-badge-discovery, body[data-theme="yellow"] #cart-badge-preview, body[data-theme="yellow"] #cart-badge-discovery, body[data-theme="orange"] #cart-badge-preview, body[data-theme="orange"] #cart-badge-discovery { color: var(--text-color-dark); }
         body[data-theme="mono-dark"] #cart-badge-preview, body[data-theme="mono-dark"] #cart-badge-discovery { color: var(--main-bg-color-mono-dark); border-color: var(--text-color-dark-mono-dark); }

        /* Media Queries */
        @media (min-width: 600px) {
             html { font-size: 17px; } body:not(.full-screen-mode) { padding: 30px 20px; } .app-container:not(body.full-screen-mode *) { max-width: 500px; border-radius: 45px; min-height: 650px; } .screen { padding: 30px 30px; } .screen-content { padding-bottom: 80px; } .header { margin-bottom: 40px; min-height: 70px; } .header-button { padding: 10px 15px; } .cart-icon, .user-icon { width: 50px; height: 50px; font-size: 1.8rem; } .menu-grid { gap: 20px; grid-template-columns: repeat(3, 1fr); } .cart-item img { width: 75px; height: 75px; } .item-details { margin-right: 35px; } html[lang="ar"] .item-details { margin-left: 35px; margin-right: 10px; } .remove-item-button { width: 22px; height: 22px; font-size: 0.9rem; line-height: 20px; } .total-calculation { max-height: 100px; } .preview-image { max-width: 280px; } .preview-name { font-size: 1.9rem; } .preview-description { font-size: 1rem; max-width: 600px; } .preview-price { font-size: 1.4rem; } .add-to-cart-preview-button { max-width: 280px; font-size: 1.3rem; } .order-log-container { max-height: 250px; } .order-preview-section { min-height: 200px; }
            .discovery-offers-scroller { gap: 25px; }
            .offer-card { flex-basis: 75%; max-width: 340px; }
            .discovery-suggestions-grid { grid-template-columns: repeat(auto-fit, minmax(210px, 1fr)); }
            .discovery-category-item { flex-basis: 170px; padding: 15px; }
            .discovery-section h4 { font-size: 1.6rem; }
            .discovery-category-section h5 { font-size: 1.4rem; }
            /* Increased sizes for suggestion images */
            .suggestion-item-images { min-height: 55px; } /* Adjust min height */
            .suggestion-item-images img { width: 50px; height: 50px; }
            .suggestion-item-images .plus-separator { font-size: 1.4rem; }
            /* REMOVED: Sort Actions Container Media Query */
        }
        @media (min-width: 992px) {
             html { font-size: 18px; } body:not(.full-screen-mode) { padding: 40px 30px; align-items: center; } .app-container:not(body.full-screen-mode *) { max-width: 800px; min-height: 700px; border-radius: 50px; } .screen { padding: 35px 40px; } .screen-content { padding-bottom: 90px; } h2 { font-size: 2.5rem; } h4 { font-size: 2rem; } #screen-5 h4 { font-size: 1.7rem; } .menu-grid { grid-template-columns: repeat(3, 1fr); gap: 30px; } .cart-total { gap: 10px; } .total-calculation { max-height: 120px; } .item-preview-container { padding-top: 20px; } .preview-image { max-width: 350px; } .preview-name { font-size: 2.2rem; } .preview-description { font-size: 1.1rem; max-width: 700px; } .preview-price { font-size: 1.5rem; padding: 8px 25px; } .add-to-cart-preview-button { max-width: 320px; padding: 14px 25px; font-size: 1.4rem; } .management-container { gap: 30px; } .order-management-layout { flex-direction: row; align-items: flex-start; gap: 25px; width: 100%; } html[lang="ar"] .order-management-layout { flex-direction: row-reverse; } .order-log-section { flex: 1 1 45%; } .order-log-container { max-height: 420px; } .order-preview-section { flex: 1 1 55%; min-height: 420px; } .order-preview-content { font-size: 1rem; }
             #screen-8 .screen-content { gap: 60px; }
             .discovery-offers-scroller { gap: 30px; }
             .offer-card { flex-basis: 65%; max-width: 380px; }
             .discovery-suggestions-grid { grid-template-columns: repeat(auto-fit, minmax(230px, 1fr)); gap: 25px; }
             .discovery-category-item { flex-basis: 190px; }
             /* Increased sizes for suggestion images */
             .suggestion-item-images { min-height: 60px; } /* Adjust min height */
             .suggestion-item-images img { width: 55px; height: 55px; }
             .suggestion-item-images .plus-separator { font-size: 1.5rem; }
        }
        @media (min-width: 1200px) {
             .app-container:not(body.full-screen-mode *) { max-width: 900px; } .screen { padding-left: 50px; padding-right: 50px; } .menu-grid { grid-template-columns: repeat(4, 1fr); gap: 30px; } .order-log-container { max-height: 500px; } .order-preview-section { min-height: 500px; }
              .offer-card { flex-basis: 55%; max-width: 400px; }
             .discovery-suggestions-grid { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
             .discovery-category-item { flex-basis: 210px; }
             /* Increased sizes for suggestion images */
             .suggestion-item-images { min-height: 65px; } /* Adjust min height */
             .suggestion-item-images img { width: 60px; height: 60px; }
             .suggestion-item-images .plus-separator { font-size: 1.6rem; }
         }

    </style>
</head>
<body data-theme="blue"> <!-- Default theme set here -->

    <!-- MOVED Fixed Buttons Outside App Container -->
    <button id="toggle-fullscreen-btn" class="fixed-button" title="Enter Full Screen"><i class="fas fa-expand"></i></button>
    <button id="settings-btn" class="fixed-button" title="Settings"><i class="fas fa-cog"></i></button>

    <div class="app-container">
        <!-- Screen 1: Login --> <div class="screen" id="screen-1"> <div class="screen-content"> <h2 class="screen-title" data-lang-key="welcome_title">Welcome to<br>EVA Canteen</h2> <div class="form-box"> <h3 data-lang-key="sign_in_label">sign in</h3> <input type="email" id="login-email" data-lang-placeholder-key="email_placeholder" placeholder="email....."> <input type="password" id="login-password" data-lang-placeholder-key="password_placeholder" placeholder="password*****"> <p id="login-error" class="error-message" data-lang-key="login_error_invalid">Invalid credentials (use any)</p> </div> <button class="button submit-button" id="login-submit" data-lang-key="submit_button">submit</button> <div class="switch-account"> <p data-lang-key="new_account_prompt">new account?</p> <button class="button rect-button register-button" data-target="screen-2" data-lang-key="register_button">Register</button> </div> <button class="button small-button" id="goto-admin-login-button" style="margin-top: 25px; background-color: #ffc107; width: auto;"> <i class="fas fa-cog"></i> <span data-lang-key="management_button">Management</span> </button> </div> </div>
        <!-- Screen 2: Register --> <div class="screen" id="screen-2"> <div class="screen-content"> <h2 class="screen-title" data-lang-key="welcome_title">Welcome to<br>EVA Canteen</h2> <div class="form-box"> <h3 data-lang-key="register_button">Register</h3> <input type="email" id="register-email" data-lang-placeholder-key="email_placeholder" placeholder="email....."> <input type="password" id="register-password" data-lang-placeholder-key="password_placeholder" placeholder="password*****"> <input type="password" id="register-password-confirm" data-lang-placeholder-key="password_again_placeholder" placeholder="password again*****"> <p id="register-error" class="error-message" data-lang-key="register_error_match">Passwords don't match or field empty.</p> <p class="pick-photo-label" data-lang-key="pick_photo_label">pick photo</p> <div class="photo-picker" id="register-photo-picker"> <img src="https://i.postimg.cc/6pkqNQdB/file-000000005f5052309370194ce0d09274-conversation-id-67e85992-b064-8005-abf6-a96aee541aaf-message-i.png" alt="Profile Pic 1" class="profile-pic"> <img src="https://i.postimg.cc/XYGqh5B2/IMG.png" alt="Profile Pic 2" class="profile-pic active"> <img src="https://i.postimg.cc/sXy2v068/file-000000000cb852309a865637b17bf852-conversation-id-67e85992-b064-8005-abf6-a96aee541aaf-message-i.png" alt="Profile Pic 3" class="profile-pic"> </div> </div> <button class="button submit-button" id="register-submit" data-lang-key="submit_button">submit</button> <button class="button back-button" data-target="screen-1"> <i class="fas fa-arrow-left"></i> <span data-lang-key="back_to_login_button">Back to Login</span> </button> </div> </div>
        <!-- Screen 3: Menu -->
        <div class="screen" id="screen-3">
            <div class="screen-content">
                <div class="header">
                     <button class="header-button logout-button" id="logout-button">
                         <span data-lang-key="logout_button">Log out</span> <i class="fas fa-arrow-left"></i>
                     </button>
                     <h3 class="screen-title" data-lang-key="canteen_name">EVA Canteen</h3>
                     <div class="cart-icon-container" data-target="screen-4"> <div class="cart-icon"><i class="fas fa-shopping-cart"></i><span class="cart-badge" id="cart-badge">0</span></div> <span data-lang-key="cart_label">Cart</span> </div>
                 </div>
                <!-- MODIFIED: Restored Sort Options Position -->
                <div class="sort-options">
                    <p data-lang-key="sort_label">Sort</p>
                    <div class="sort-buttons" id="menu-sort-buttons">
                        <button class="sort-button active" data-category="sweet" data-lang-key="sort_sweet">sweet</button>
                        <button class="sort-button" data-category="lunch" data-lang-key="sort_lunch">lunch</button>
                        <button class="sort-button" data-category="snacks" data-lang-key="sort_snacks">snacks</button>
                    </div>
                </div>
                <!-- MODIFIED: Discover Button (position updated, still hidden initially) -->
                <button class="button small-button" id="discover-button" style="display: none; margin-top: -5px; margin-bottom: 20px;">
                     <i class="fas fa-compass"></i> <span data-lang-key="discover_button">Discover</span>
                </button>

                 <div class="menu-grid" id="menu-grid"></div>
             </div>
        </div>
        <!-- Screen 4: Cart --> <div class="screen" id="screen-4"> <div class="screen-content">
            <div class="header">
                <button class="header-button" data-target="screen-3">
                    <span data-lang-key="menu_label">Menu</span> <i class="fas fa-utensils"></i>
                </button>
                <h3 class="screen-title" data-lang-key="canteen_name">EVA Canteen</h3>
                <div class="user-icon-container"> <div class="user-icon"> <img id="user-profile-image-display" src="" alt="User Profile" style="display: none;"> <i id="guest-user-icon" class="fas fa-user" style="display: block;"></i> </div> <span id="user-display-name">@guest</span> </div>
            </div> <h4 data-lang-key="cart_label">Cart</h4> <div class="cart-items" id="cart-items-container"></div> <div class="cart-total"> <h4 data-lang-key="total_label">Total</h4> <div class="total-calculation" id="total-calculation-details"></div> <div class="payment-method-section"> <p class="payment-label" data-lang-key="payment_method_label">Payment Method</p> <div class="payment-methods" id="payment-methods"> <button class="sort-button payment-button active" data-method="cash"> <i class="fas fa-money-bill-wave"></i> <span data-lang-key="payment_cash">Cash</span> </button> <button class="sort-button payment-button" data-method="card"> <i class="fas fa-credit-card"></i> <span data-lang-key="payment_card">Card</span> </button> </div> </div> <span class="final-equals">=</span> <span class="total-amount-button" id="checkout-button">0 L.E</span> </div> </div> </div>
        <!-- Screen 6: Admin Login --> <div class="screen" id="screen-6"> <div class="screen-content"> <h2 class="screen-title" data-lang-key="admin_login_title">Management<br>Login</h2> <div class="form-box"> <h3 data-lang-key="admin_enter_creds">Enter Credentials</h3> <input type="email" id="admin-email" data-lang-placeholder-key="admin_email_placeholder" placeholder="admin email....." value="admin@canteen.app"> <input type="password" id="admin-password" data-lang-placeholder-key="admin_password_placeholder" placeholder="admin password*****" value="admin123"> <p id="admin-login-error" class="error-message" data-lang-key="admin_login_error">Invalid admin credentials.</p> </div> <button class="button submit-button" id="admin-login-submit" data-lang-key="login_button">Login</button> <button class="button back-button" data-target="screen-1"> <i class="fas fa-arrow-left"></i> <span data-lang-key="back_to_welcome_button">Back to Welcome</span> </button> </div> </div>
        <!-- Screen 5: Order Management --> <div class="screen" id="screen-5"> <div class="screen-content management-container">
             <div class="header">
                 <button class="header-button back-to-login-button" id="mgmt-back-to-login">
                     <span data-lang-key="exit_button">Exit</span> <i class="fas fa-sign-out-alt"></i>
                 </button>
                 <h3 class="screen-title" data-lang-key="order_management_title">Order Management</h3>
                 <div style="width: 80px; flex-shrink: 0;"></div> <!-- Keep Spacer -->
             </div>
             <div class="search-section"> <input type="text" id="order-search-input" data-lang-placeholder-key="search_order_id_placeholder" placeholder="Search by Order ID..."> <button class="button small-button" id="order-search-button"><i class="fas fa-search"></i> <span data-lang-key="search_button">Search</span></button> </div> <div class="order-management-layout"> <div class="order-log-section"> <h4 data-lang-key="order_log_title">Order Log</h4> <div class="order-log-container" id="order-log-container"></div> </div> <div class="order-preview-section" id="order-preview-section"> <h4 data-lang-key="order_preview_title">Order Preview</h4> <div class="order-preview-content" id="order-preview-content"></div> <div class="order-status-controls" id="order-status-controls"></div> </div> </div> </div> </div>
        <!-- Screen 7: Item Preview -->
        <div class="screen" id="screen-7">
             <div class="screen-content item-preview-container">
                 <div class="header">
                     {/* <!-- MODIFIED: ID added for easier targeting --> */}
                     <button class="header-button back-button" id="item-preview-back-button">
                         <i class="fas fa-arrow-left"></i> <span data-lang-key="back_button">Back</span>
                     </button>
                     <h3 class="screen-title" data-lang-key="item_details_title">Item Details</h3>
                     <div class="cart-icon-container" data-target="screen-4" style="visibility: visible;">
                         <div class="cart-icon">
                             <i class="fas fa-shopping-cart"></i>
                             <span class="cart-badge" id="cart-badge-preview">0</span>
                         </div>
                         <span data-lang-key="cart_label">Cart</span>
                     </div>
                 </div>
                 <img id="preview-item-image" src="https://via.placeholder.com/220x165/eee?text=Loading..." alt="Item Image" class="preview-image">
                 <h3 id="preview-item-name" class="preview-name" data-lang-key="item_name_placeholder">Item Name</h3>
                 <p id="preview-item-description" class="preview-description" data-lang-key="item_description_placeholder">Item description loading...</p>
                 <p id="preview-item-price" class="preview-price">0 L.E</p>
                 <button class="button add-to-cart-preview-button" id="add-to-cart-preview-button">
                     <i class="fas fa-cart-plus"></i> <span data-lang-key="add_to_cart_button">Add to Cart</span>
                 </button>
            </div>
        </div>

        <!-- Screen 8: Discovery Mode -->
        <div class="screen" id="screen-8">
            <div class="screen-content">
                <div class="header">
                    <button class="header-button" data-target="screen-3">
                        <i class="fas fa-arrow-left"></i> <span data-lang-key="back_button">Back</span>
                    </button>
                    <h3 class="screen-title" data-lang-key="discovery_mode_title">Discovery Mode</h3>
                    <div class="cart-icon-container" data-target="screen-4" style="visibility: visible;">
                        <div class="cart-icon">
                            <i class="fas fa-shopping-cart"></i>
                            <span class="cart-badge" id="cart-badge-discovery">0</span>
                        </div>
                        <span data-lang-key="cart_label">Cart</span>
                    </div>
                </div>
                <section class="discovery-section discovery-section-bundles"> <h4 data-lang-key="discovery_bundles_title">Special Bundles</h4> <div class="discovery-offers-scroller" id="discovery-bundles-scroller"></div> </section>
                <section class="discovery-section discovery-section-ideas"> <h4 data-lang-key="discovery_suggestions_title">Meal Ideas</h4> <div class="discovery-suggestions-grid" id="discovery-suggestions-grid"></div> </section>
                <section class="discovery-section discovery-section-all-items"> <h4 data-lang-key="discovery_all_items_title">Explore the Menu</h4> <div class="discovery-categories-container" id="discovery-categories-container"></div> </section>
            </div>
        </div>
        <!-- End Screen 8 -->

    </div><!-- end app-container -->

     <!-- Floating Settings Panel -->
    <div id="settings-panel">
        <!-- Language Section -->
        <div class="settings-group" id="language-group">
            <span class="settings-label" data-lang-key="language_setting_label">Language</span>
            <div class="settings-current-display" id="current-language-display" tabindex="0" role="button" aria-haspopup="listbox" aria-expanded="false">
                <span id="current-language-text">English</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="settings-options-list language-options" id="language-options" role="listbox">
                <div class="option-item active" data-lang="en" role="option" aria-selected="true"> <span>English</span> <i class="fas fa-check"></i> </div>
                <div class="option-item" data-lang="ar" role="option" aria-selected="false"> <span></span> <i class="fas fa-check"></i> </div>
            </div>
        </div>

        <!-- Theme Section -->
        <div class="settings-group" id="theme-group">
            <span class="settings-label" data-lang-key="theme_setting_label">App Theme</span>
            <div class="settings-current-display" id="current-theme-display" tabindex="0" role="button" aria-haspopup="listbox" aria-expanded="false">
                <span class="theme-swatch swatch-blue" id="current-theme-swatch"></span>
                <span id="current-theme-text">Default Blue</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="settings-options-list theme-options" id="theme-options" role="listbox">
                 <div class="option-item active" data-theme="blue" role="option" aria-selected="true"> <span class="theme-swatch swatch-blue"></span> <span data-lang-key="theme_blue">Default Blue</span> <i class="fas fa-check"></i> </div>
                 <div class="option-item" data-theme="green" role="option" aria-selected="false"> <span class="theme-swatch swatch-green"></span> <span data-lang-key="theme_green">Green</span> <i class="fas fa-check"></i> </div>
                 <div class="option-item" data-theme="purple" role="option" aria-selected="false"> <span class="theme-swatch swatch-purple"></span> <span data-lang-key="theme_purple">Purple</span> <i class="fas fa-check"></i> </div>
                 <div class="option-item" data-theme="light-blue" role="option" aria-selected="false"> <span class="theme-swatch swatch-light-blue"></span> <span data-lang-key="theme_light_blue">Light Blue</span> <i class="fas fa-check"></i> </div>
                 <div class="option-item" data-theme="mono-light" role="option" aria-selected="false"> <span class="theme-swatch swatch-mono-light"></span> <span data-lang-key="theme_mono_light">Monochrome Light</span> <i class="fas fa-check"></i> </div>
                 <div class="option-item" data-theme="dark-grey" role="option" aria-selected="false"> <span class="theme-swatch swatch-dark-grey"></span> <span data-lang-key="theme_dark_grey">Dark Grey</span> <i class="fas fa-check"></i> </div>
                 <div class="option-item" data-theme="night" role="option" aria-selected="false"> <span class="theme-swatch swatch-night"></span> <span data-lang-key="theme_night">Night Mode</span> <i class="fas fa-check"></i> </div>
                 <div class="option-item" data-theme="mono-dark" role="option" aria-selected="false"> <span class="theme-swatch swatch-mono-dark"></span> <span data-lang-key="theme_mono_dark">Monochrome Dark</span> <i class="fas fa-check"></i> </div>
                 <div class="option-item" data-theme="yellow" role="option" aria-selected="false"> <span class="theme-swatch swatch-yellow"></span> <span data-lang-key="theme_yellow">Yellow</span> <i class="fas fa-check"></i> </div>
                 <div class="option-item" data-theme="orange" role="option" aria-selected="false"> <span class="theme-swatch swatch-orange"></span> <span data-lang-key="theme_orange">Orange</span> <i class="fas fa-check"></i> </div>
            </div>
        </div>

        <!-- Discovery Mode Toggle Section (with Passcode) -->
        <div class="settings-group" id="discovery-toggle-group">
            <span class="settings-label" data-lang-key="discovery_mode_enable_label">Enable Discovery Mode</span>
            <div class="settings-toggle" id="discovery-mode-toggle" role="switch" aria-checked="false" tabindex="0">
                <div class="toggle-switch"></div>
            </div>
        </div>
        <!-- End Discovery Mode Toggle Section -->

    </div>
    <!-- End Floating Settings Panel -->

    <!-- Custom Alert Modal -->
    <div id="custom-alert-overlay" class="modal-overlay">
        <div id="custom-alert-box" class="modal-box">
            <h3 data-lang-key="checkout_success_title">Order Confirmed!</h3>
            <p id="custom-alert-message"></p>
            <button id="custom-alert-close" class="button" data-lang-key="ok_button">OK</button>
        </div>
    </div>
    <!-- End Custom Alert Modal -->

    <!-- Passcode Modal -->
    <div id="passcode-modal-overlay" class="modal-overlay">
        <div id="passcode-modal-box" class="modal-box">
            <h3 id="passcode-modal-title" data-lang-key="discovery_passcode_modal_title">Enter Passcode</h3>
            <input type="password" id="passcode-modal-input" data-lang-placeholder-key="discovery_passcode_prompt" placeholder="Enter Discovery Mode Passcode:">
            <p id="passcode-modal-error" class="error-message" data-lang-key="discovery_passcode_incorrect_message">Incorrect passcode entered.</p>
            <div class="passcode-modal-buttons">
                <!-- Changed PIN to Cancel -->
                <button id="passcode-modal-cancel" class="button cancel-button" data-lang-key="cancel_button">Cancel</button>
                <button id="passcode-modal-ok" class="button ok-button" data-lang-key="ok_button">OK</button>
            </div>
        </div>
    </div>
    <!-- End Passcode Modal -->


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Element References ---
            const appContainer = document.querySelector('.app-container'),
                  allScreens = document.querySelectorAll('.screen'),
                  navigationElements = document.querySelectorAll('[data-target]'),
                  htmlElement = document.documentElement,
                  bodyElement = document.body,
                  loginEmailInput = document.getElementById('login-email'),
                  loginPasswordInput = document.getElementById('login-password'),
                  loginSubmitButton = document.getElementById('login-submit'),
                  loginErrorMsg = document.getElementById('login-error'),
                  gotoAdminLoginButton = document.getElementById('goto-admin-login-button'),
                  registerEmailInput = document.getElementById('register-email'),
                  registerPasswordInput = document.getElementById('register-password'),
                  registerPasswordConfirmInput = document.getElementById('register-password-confirm'),
                  registerPhotoPicker = document.getElementById('register-photo-picker'),
                  registerSubmitButton = document.getElementById('register-submit'),
                  registerErrorMsg = document.getElementById('register-error'),
                  logoutButton = document.getElementById('logout-button'),
                  menuGrid = document.getElementById('menu-grid'),
                  menuSortButtonsContainer = document.getElementById('menu-sort-buttons'),
                  discoverButton = document.getElementById('discover-button'), // Button on Screen 3
                  cartBadge = document.getElementById('cart-badge'),
                  cartItemsContainer = document.getElementById('cart-items-container'),
                  totalCalculationDetails = document.getElementById('total-calculation-details'),
                  checkoutButton = document.getElementById('checkout-button'),
                  userDisplayName = document.getElementById('user-display-name'),
                  userProfileImage = document.getElementById('user-profile-image-display'),
                  guestUserIcon = document.getElementById('guest-user-icon'),
                  paymentMethodsContainer = document.getElementById('payment-methods'),
                  adminEmailInput = document.getElementById('admin-email'),
                  adminPasswordInput = document.getElementById('admin-password'),
                  adminLoginSubmitButton = document.getElementById('admin-login-submit'),
                  adminLoginErrorMsg = document.getElementById('admin-login-error'),
                  mgmtBackToLoginButton = document.getElementById('mgmt-back-to-login'),
                  orderSearchInput = document.getElementById('order-search-input'),
                  orderSearchButton = document.getElementById('order-search-button'),
                  orderLogContainer = document.getElementById('order-log-container'),
                  orderPreviewSection = document.getElementById('order-preview-section'),
                  orderPreviewContent = document.getElementById('order-preview-content'),
                  orderStatusControls = document.getElementById('order-status-controls'),
                  // Screen 7 elements
                  itemPreviewBackButton = document.getElementById('item-preview-back-button'),
                  previewItemImage = document.getElementById('preview-item-image'),
                  previewItemName = document.getElementById('preview-item-name'),
                  previewItemDescription = document.getElementById('preview-item-description'),
                  previewItemPrice = document.getElementById('preview-item-price'),
                  addToCartPreviewButton = document.getElementById('add-to-cart-preview-button'),
                  cartBadgePreview = document.getElementById('cart-badge-preview'),
                  // Screen 8 elements
                  cartBadgeDiscovery = document.getElementById('cart-badge-discovery'),
                  discoveryBundlesScroller = document.getElementById('discovery-bundles-scroller'),
                  discoverySuggestionsGrid = document.getElementById('discovery-suggestions-grid'),
                  discoveryCategoriesContainer = document.getElementById('discovery-categories-container'),
                  // Fixed & Settings
                  toggleFullScreenButton = document.getElementById('toggle-fullscreen-btn'),
                  settingsBtn = document.getElementById('settings-btn'),
                  settingsPanel = document.getElementById('settings-panel'),
                  languageGroup = document.getElementById('language-group'),
                  currentLanguageDisplay = document.getElementById('current-language-display'),
                  currentLanguageText = document.getElementById('current-language-text'),
                  languageOptions = document.getElementById('language-options'),
                  themeGroup = document.getElementById('theme-group'),
                  currentThemeDisplay = document.getElementById('current-theme-display'),
                  currentThemeText = document.getElementById('current-theme-text'),
                  currentThemeSwatch = document.getElementById('current-theme-swatch'),
                  themeOptions = document.getElementById('theme-options'),
                  discoveryModeToggle = document.getElementById('discovery-mode-toggle'); // Toggle in Settings

            const customAlertOverlay = document.getElementById('custom-alert-overlay');
            const customAlertBox = document.getElementById('custom-alert-box');
            const customAlertMessage = document.getElementById('custom-alert-message');
            const customAlertCloseBtn = document.getElementById('custom-alert-close');
            const customAlertTitle = customAlertBox.querySelector('h3');

            // Passcode Modal Elements (Updated IDs)
            const passcodeModalOverlay = document.getElementById('passcode-modal-overlay');
            const passcodeModalBox = document.getElementById('passcode-modal-box');
            const passcodeModalTitle = document.getElementById('passcode-modal-title');
            const passcodeModalInput = document.getElementById('passcode-modal-input');
            const passcodeModalError = document.getElementById('passcode-modal-error');
            const passcodeModalOk = document.getElementById('passcode-modal-ok');
            const passcodeModalCancel = document.getElementById('passcode-modal-cancel');


            // --- State Variables ---
            let currentScreen = null,
                currentUser = null,
                cart = [],
                selectedPaymentMethod = 'cash',
                allOrders = [],
                currentAdminOrderSelection = null;
            const ADMIN_EMAIL = "admin@canteen.app",
                  ADMIN_PASSWORD = "admin123",
                  DISCOVERY_PASSCODE = "4321",
                  DEFAULT_PROFILE_PIC = 'https://i.postimg.cc/XYGqh5B2/IMG.png';
            let currentLanguage = localStorage.getItem('appLanguage') || 'en';
            let currentTheme = localStorage.getItem('appTheme') || 'blue';
            let isDiscoveryModeActivated = localStorage.getItem('discoveryModeActivated') === 'true';
            let previousScreenId = null; // Variable to track screen before item preview
            let previewButtonTimeout = null;
            let bundleButtonTimeouts = {};
            let suggestionButtonTimeouts = {};


            // --- Data & Translations ---
            const baseMenuData = [ /* ... (same as before) ... */ {id: 'coffee', price: 30, image: 'https://media.elwatannews.com/media/img/mediaarc/large/20237496061663046251.jpg', category: 'sweet', name_key: 'item_name_coffee', description_key: 'item_desc_coffee'}, {id: 'pizza', price: 70, image: 'https://www.foodandwine.com/thmb/4qg95tjf0mgdHqez5OLLYc0PNT4=/750x0/filters:no_upscale():max_bytes(150000):strip_icc():format(webp)/classic-cheese-pizza-FT-RECIPE0422-31a2c938fc2546c9a07b7011658cfd05.jpg', category: 'lunch', name_key: 'item_name_pizza', description_key: 'item_desc_pizza'}, {id: 'cookies', price: 20, image: 'https://interpretationfordream.com/wp-content/uploads/2024/09/069873874340983.webp', category: 'sweet', name_key: 'item_name_cookies', description_key: 'item_desc_cookies'}, {id: 'fries', price: 35, image: 'https://images.themodernproper.com/production/posts/2022/Homemade-French-Fries_8.jpg?w=1200&q=82&auto=format&fit=crop&dm=1662474181&s=687036746e03f50b6204c1390acdb537', category: 'snacks', name_key: 'item_name_fries', description_key: 'item_desc_fries'}, {id: 'burger', price: 60, image: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcScReRWtq7d-yl2aIG7jOJs5FUrxeJpi-DyfZ8OycsNa_taC8mePeUW6-JE&s=10', category: 'lunch', name_key: 'item_name_burger', description_key: 'item_desc_burger'}, {id: 'soda', price: 15, image: 'https://jx.sa/8860-large_default/soda-star-water-300-ml-x-24.jpg', category: 'snacks', name_key: 'item_name_soda', description_key: 'item_desc_soda'}, {id: 'salad', price: 45, image: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ5sqfCpGLeoxFBPGxFxzmygHlKJgDnU-SJHEx9hVIyhnrpGmldu20OirA&s=10', category: 'lunch', name_key: 'item_name_salad', description_key: 'item_desc_salad'}, {id: 'cake', price: 40, image: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRvFIIgqKfBgFotly6OrxXqxBGO_jLh-DIINS_e-_o4gaKlk3I9tvobZaKk&s=10', category: 'sweet', name_key: 'item_name_cake', description_key: 'item_desc_cake'}, {id: 'croissant', price: 25, image: 'https://static01.nyt.com/images/2021/04/07/dining/06croissantsrex1/merlin_184841898_ccc8fb62-ee41-44e8-9ddf-b95b198b88db-articleLarge.jpg', category: 'sweet', name_key: 'item_name_croissant', description_key: 'item_desc_croissant'}, {id: 'pasta', price: 55, image: 'https://images.services.kitchenstories.io/eT6sd87C6s0sOmsM8S2IDw96_Xs=/1080x0/filters:quality(85)/images.kitchenstories.io/wagtailOriginalImages/R131-final-photo-3-sg.jpg', category: 'lunch', name_key: 'item_name_pasta', description_key: 'item_desc_pasta'}, {id: 'chips', price: 10, image: 'https://preppykitchen.com/wp-content/uploads/2024/05/Homemade-Potato-Chips-Recipe-Card.jpg', category: 'snacks', name_key: 'item_name_chips', description_key: 'item_desc_chips'}, {id: 'juice', price: 20, image: 'https://images-prod.healthline.com/hlcmsresource/images/AN_images/orange-juice-1296x728-feature.jpg', category: 'sweet', name_key: 'item_name_juice', description_key: 'item_desc_juice'}, {id: 'sandwich', price: 50, image: 'https://www.dukeshill.co.uk/cdn/shop/articles/20240725081844-chicken-20bacon-20club-20sandwich-20main-20landscape_1024x1024.jpg?v=1724401314', category: 'lunch', name_key: 'item_name_sandwich', description_key: 'item_desc_sandwich'}, {id: 'muffin', price: 22, image: 'https://www.giallozafferano.com/images/269-26998/Chocolate-Chip-Muffins_1200x800.jpg', category: 'sweet', name_key: 'item_name_muffin', description_key: 'item_desc_muffin'}, {id: 'onionrings', price: 30, image: 'https://i0.wp.com/www.angsarap.net/wp-content/uploads/2015/03/Onion-Rings-Wide.jpg', category: 'snacks', name_key: 'item_name_onionrings', description_key: 'item_desc_onionrings'}, {id: 'soup', price: 35, image: 'https://i.postimg.cc/HxCYPzWN/Soup.jpg', category: 'lunch', name_key: 'item_name_soup', description_key: 'item_desc_soup'} ];
            const mealSuggestions = [ /* ... (same as before) ... */ { id: 'sugg-1', name_key: 'suggestion_burger_combo_name', description_key: 'suggestion_burger_combo_desc', itemIds: ['burger', 'fries', 'soda'] }, { id: 'sugg-2', name_key: 'suggestion_coffee_break_name', description_key: 'suggestion_coffee_break_desc', itemIds: ['coffee', 'muffin'] }, { id: 'sugg-3', name_key: 'suggestion_lunch_light_name', description_key: 'suggestion_lunch_light_desc', itemIds: ['salad', 'juice'] } ];
            const bundleOffers = [ /* ... (same as before) ... */ { id: 'bundle-lunch-deal', name_key: 'bundle_lunch_deal_name', description_key: 'bundle_lunch_deal_desc', itemIds: ['pizza', 'salad', 'soda'], discountPercent: 15 }, { id: 'bundle-sweet-treat', name_key: 'bundle_sweet_treat_name', description_key: 'bundle_sweet_treat_desc', itemIds: ['cake', 'coffee', 'croissant'], discountPercent: 20 } ];

            const translations = { welcome_title: { en: "Welcome to<br>EVA Canteen", ar: "  <br> " }, canteen_name: { en: "EVA Canteen", ar: " " }, sign_in_label: { en: "sign in", ar: " " }, email_placeholder: { en: "email.....", ar: " ....." }, password_placeholder: { en: "password*****", ar: " *****" }, password_again_placeholder: { en: "password again*****", ar: "   *****" }, submit_button: { en: "submit", ar: "" }, register_button: { en: "Register", ar: "" }, login_button: { en: "Login", ar: "" }, new_account_prompt: { en: "new account?", ar: " " }, pick_photo_label: { en: "pick photo", ar: " " }, back_to_login_button: { en: "Back to Login", ar: " " }, back_to_welcome_button: { en: "Back to Welcome", ar: " " }, back_button: { en: "Back", ar: "" }, logout_button: { en: "Log out", ar: " " }, cart_label: { en: "Cart", ar: "" }, menu_label: { en: "Menu", ar: "" }, sort_label: { en: "Sort", ar: "" }, sort_sweet: { en: "sweet", ar: "" }, sort_lunch: { en: "lunch", ar: "" }, sort_snacks: { en: "snacks", ar: "" }, total_label: { en: "Total", ar: "" }, payment_method_label: { en: "Payment Method", ar: " " }, payment_cash: { en: "Cash", ar: "" }, payment_card: { en: "Card", ar: "" }, add_to_cart_button: { en: "Add to Cart", ar: "  " }, added_to_cart_button: { en: "Added!", ar: " !" }, item_details_title: { en: "Item Details", ar: " " }, item_name_placeholder: { en: "Item Name", ar: " " }, item_description_placeholder: { en: "Item description loading...", ar: "   ..." }, cart_empty_message: { en: "Your cart is empty.", ar: " ." }, checkout_success_alert: { en: "Payment Method: {method}\nOrder ID: {id}\n\nYour order is placed (simulation).", ar: ": {total}\n : {method}\n : {id}\n\n   ()." }, checkout_success_title: { en: "Order Confirmed!", ar: "  !" }, ok_button: { en: "OK", ar: "" }, cart_is_empty_alert: { en: "Your cart is empty!", ar: " !" }, currency_symbol: { en: "L.E", ar: "." }, quantity_prefix: { en: "x", ar: "" }, login_error_invalid: { en: "Invalid credentials.", ar: "   ." }, login_error_fields: { en: "Please enter email and password.", ar: "     ." }, register_error_match: { en: "Passwords don't match or field empty.", ar: "      ." }, register_error_fields: { en: "Please fill all fields.", ar: "   ." }, register_error_photo: { en: "Please select a profile picture.", ar: "   ." }, management_button: { en: "Management", ar: "" }, admin_login_title: { en: "Management<br>Login", ar: " <br>" }, admin_enter_creds: { en: "Enter Credentials", ar: "  " }, admin_email_placeholder: { en: "admin email.....", ar: " ....." }, admin_password_placeholder: { en: "admin password*****", ar: "  *****" }, admin_login_error: { en: "Invalid admin credentials.", ar: "    ." }, exit_button: { en: "Exit", ar: "" }, order_management_title: { en: "Order Management", ar: " " }, search_order_id_placeholder: { en: "Search by Order ID...", ar: "  ..." }, search_button: { en: "Search", ar: "" }, order_log_title: { en: "Order Log", ar: " " }, no_orders_found: { en: "No orders found.", ar: "    ." }, order_preview_title: { en: "Order Preview", ar: " " }, order_preview_placeholder: { en: "Select an order from the log to view details.", ar: "     ." }, order_id_label: { en: "Order ID", ar: " " }, order_placed_label: { en: "Placed", ar: " " }, order_status_label: { en: "Status", ar: "" }, order_payment_label: { en: "Payment", ar: "" }, order_total_label: { en: "Total", ar: "" }, order_items_label: { en: "Items", ar: "" }, order_status_pending: { en: "pending", ar: " " }, order_status_preparing: { en: "preparing", ar: " " }, order_status_delivered: { en: "delivered", ar: " " },
                 subtotal_label: { en: "Subtotal", ar: "  " }, // ADDED Subtotal translation
                 settings_title: { en: "Settings", ar: "" }, settings_button_label: { en: "Settings", ar: "" }, language_setting_label: { en: "Language", ar: "" }, theme_setting_label: { en: "App Theme", ar: " " },
                 theme_blue: { en: "Blue (Default)", ar: " ()" }, theme_green: { en: "Green", ar: "" }, theme_purple: { en: "Purple", ar: "" },
                 theme_light_blue: { en: "Light Blue", ar: " " }, theme_mono_light: { en: "Monochrome Light", ar: "  " }, theme_dark_grey: { en: "Dark Grey", ar: " " }, theme_night: { en: "Night Mode", ar: " " },
                 theme_mono_dark: { en: "Monochrome Dark", ar: "  " },
                 theme_yellow: { en: "Yellow", ar: "" },
                 theme_orange: { en: "Orange", ar: "" },
                 item_name_coffee: { en: "Coffee", ar: "" }, item_name_pizza: { en: "Pizza", ar: "" }, item_name_cookies: { en: "Cookies", ar: "" }, item_name_fries: { en: "French fries", ar: " " }, item_name_burger: { en: "Burger", ar: "" }, item_name_soda: { en: "Soda", ar: "" }, item_name_salad: { en: "Salad", ar: "" }, item_name_cake: { en: "Cake Slice", ar: " " }, item_name_croissant: { en: "Croissant", ar: "" }, item_name_pasta: { en: "Pasta Aglio e Olio", ar: "   " }, item_name_chips: { en: "Potato Chips", ar: " " }, item_name_juice: { en: "Orange Juice", ar: " " }, item_name_sandwich: { en: "Club Sandwich", ar: " " }, item_name_muffin: { en: "Muffin", ar: "" }, item_name_onionrings: { en: "Onion Rings", ar: " " }, item_name_soup: { en: "Soup of the Day", ar: " " },
                 item_desc_coffee: { en: "A rich and aromatic blend, perfect to kickstart your day or enjoy a relaxing break.", ar: "         ." }, item_desc_pizza: { en: "Classic cheese pizza with a tangy tomato sauce and a crispy crust. Always a favorite!", ar: "       .   !" }, item_desc_cookies: { en: "Deliciously chewy chocolate chip cookies, baked fresh. Irresistible!", ar: "     .  !" }, item_desc_fries: { en: "Crispy golden french fries, lightly salted. The perfect side or snack.", ar: "     .      ." }, item_desc_burger: { en: "Juicy beef patty on a toasted bun with lettuce, tomato, and our special sauce.", ar: "           ." }, item_desc_soda: { en: "A cold and refreshing fizzy drink to quench your thirst.", ar: "     ." }, item_desc_salad: { en: "A fresh mix of greens, vegetables, and a light vinaigrette dressing. Healthy and tasty!", ar: "        .  !" }, item_desc_cake: { en: "A moist and decadent slice of chocolate cake with creamy frosting. Pure indulgence!", ar: "       .  !" }, item_desc_croissant: { en: "A buttery, flaky, viennoiserie pastry inspired by the shape of the Austrian kipferl.", ar: "        ." }, item_desc_pasta: { en: "Simple yet delicious Italian pasta dish with garlic, olive oil, and red pepper flakes.", ar: "           ." }, item_desc_chips: { en: "Thinly sliced potatoes, deep-fried or baked until crispy. The ultimate salty snack!", ar: "        .    !" }, item_desc_juice: { en: "Freshly squeezed orange juice, packed with Vitamin C and natural sweetness.", ar: "       ." }, item_desc_sandwich: { en: "Classic club sandwich with layers of turkey, bacon, lettuce, tomato, and mayo on toasted bread.", ar: "              ." }, item_desc_muffin: { en: "A soft and moist muffin, perfect for breakfast or a sweet treat. Ask for today's flavor!", ar: "      .    !" }, item_desc_onionrings: { en: "Thick-cut onion rings coated in a crispy batter and fried to golden perfection.", ar: "         ." }, item_desc_soup: { en: "Warm and comforting soup made fresh daily. Please ask your server for today's selection.", ar: "     .      ." }, item_desc_default: { en: "A tasty item from our menu.", ar: "   ." },
                 // Discovery Mode Translations
                 discover_button: { en: "Discover", ar: "" },
                 discovery_mode_title: { en: "Discovery Mode", ar: " " },
                 discovery_mode_enable_label: { en: "Enable Discovery Mode", ar: "  " },
                 discovery_bundles_title: { en: "Special Bundles", ar: " " },
                 discovery_suggestions_title: { en: "Meal Ideas", ar: " " },
                 discovery_all_items_title: { en: "Explore the Menu", ar: " " },
                 suggestion_burger_combo_name: { en: "Classic Combo", ar: " " },
                 suggestion_burger_combo_desc: { en: "The perfect trio: Burger, Fries, and Soda.", ar: " :   ." },
                 suggestion_coffee_break_name: { en: "Coffee Break", ar: " " },
                 suggestion_coffee_break_desc: { en: "Relax with a warm Coffee and a soft Muffin.", ar: "     ." },
                 suggestion_lunch_light_name: { en: "Light Lunch", ar: " " },
                 suggestion_lunch_light_desc: { en: "A healthy and refreshing Salad paired with Juice.", ar: "    ." },
                 bundle_lunch_deal_name: { en: "Lunch Power Deal", ar: "  " },
                 bundle_lunch_deal_desc: { en: "Grab a Pizza, Salad, and Soda together and save!", ar: "      !" },
                 bundle_sweet_treat_name: { en: "Sweet Treat Bundle", ar: "  " },
                 bundle_sweet_treat_desc: { en: "Indulge with Cake, Coffee, and a Croissant at a special price.", ar: "      ." },
                 add_bundle_button: { en: "Add Bundle", ar: " " },
                 bundle_added_button: { en: "Bundle Added!", ar: "  !" },
                 discount_tag: { en: "{percent}% OFF", ar: " {percent}%" },
                 includes_items: { en: "Includes:", ar: ":" },
                 original_price: { en: "Original:", ar: ":" },
                 bundle_price: { en: "Bundle Price:", ar: " :" },
                 add_suggestion_button: { en: "Add All Items", ar: "  " },
                 suggestion_added_button: { en: "Items Added!", ar: "  !" },
                 suggestion_total_price: { en: "Total Price:", ar: " :" },
                 bundle_discount_applied: { en: "Bundle Discount", ar: " " },
             };
            // Integrated Passcode Modal Translations (Updated Keys)
            translations['discovery_passcode_prompt'] = { en: "Enter Discovery Mode Passcode:", ar: "    :" };
            translations['discovery_passcode_modal_title'] = { en: "Enter Passcode", ar: " " };
            translations['discovery_passcode_incorrect_message'] = { en: "Incorrect passcode entered.", ar: "     ." };
            translations['cancel_button'] = { en: "Cancel", ar: "" };


            // --- Helper Functions ---
            function getText(key) { const ts = translations[key]; if (ts) return ts[currentLanguage] || ts['en'] || `[${key}]`; console.warn(`TKey not found: ${key}`); return `[${key}]`; }
            function getCurrency() { return getText('currency_symbol'); } function formatPrice(p) { return `${p} ${getCurrency()}`; }

            // --- Theme Switching Function ---
            function applyTheme(themeName) { console.log("Applying theme:", themeName); bodyElement.dataset.theme = themeName; currentTheme = themeName; localStorage.setItem('appTheme', themeName); if (settingsPanel) updateThemeDisplay(); }

            // --- Settings Panel Logic ---
            function toggleSettingsPanel(show) { if (!settingsPanel) return; const i = settingsPanel.classList.contains('visible'); if (typeof show === 'boolean') { if (show && !i) { settingsPanel.classList.add('visible'); document.addEventListener('click', handleOutsideSettingsClick, true); updateSettingsDisplays(); } else if (!show && i) { closeAllSettingsDropdowns(); settingsPanel.classList.remove('visible'); document.removeEventListener('click', handleOutsideSettingsClick, true); } } else { toggleSettingsPanel(!i); } }
            function handleOutsideSettingsClick(e) { if (settingsPanel && !settingsPanel.contains(e.target) && settingsBtn && !settingsBtn.contains(e.target)) { toggleSettingsPanel(false); } else { const isDropdownControl = currentLanguageDisplay?.contains(e.target) || currentThemeDisplay?.contains(e.target); const isDropdownList = languageOptions?.contains(e.target) || themeOptions?.contains(e.target); const isToggleControl = discoveryModeToggle?.contains(e.target); /* Check for toggle click */ if (settingsPanel && settingsPanel.contains(e.target) && !isDropdownControl && !isDropdownList && !isToggleControl) { closeAllSettingsDropdowns(); } } }
            function toggleSettingsDropdown(g) { if (!g) return; const o = g === languageGroup ? themeGroup : languageGroup; const i = !g.classList.contains('open'); const d = g.querySelector('.settings-current-display'); const l = g.querySelector('.settings-options-list'); if (i && o && o.classList.contains('open')) { o.classList.remove('open', 'open-upward'); const oD = o.querySelector('.settings-current-display'); if (oD) oD.setAttribute('aria-expanded', 'false'); } let u = false; if (i && d && l) { const e = 150; const r = d.getBoundingClientRect(); const sB = window.innerHeight - r.bottom - 10; const sA = r.top - 10; if (sB < e && sA > sB) { u = true; } } g.classList.remove('open-upward'); if(i) { if (u) { g.classList.add('open-upward'); } g.classList.add('open'); } else { g.classList.remove('open'); } if (d) d.setAttribute('aria-expanded', i); }
            function closeAllSettingsDropdowns() { if(languageGroup) languageGroup.classList.remove('open', 'open-upward'); if(themeGroup) themeGroup.classList.remove('open', 'open-upward'); if(currentLanguageDisplay) currentLanguageDisplay.setAttribute('aria-expanded', 'false'); if(currentThemeDisplay) currentThemeDisplay.setAttribute('aria-expanded', 'false'); }
            function updateLanguageDisplay() { const s = languageOptions?.querySelector(`.option-item[data-lang="${currentLanguage}"]`); if (s && currentLanguageText) { currentLanguageText.textContent = s.querySelector('span').textContent; languageOptions?.querySelectorAll('.option-item').forEach(i => { const a = i.dataset.lang === currentLanguage; i.classList.toggle('active', a); i.setAttribute('aria-selected', a); }); } }
            function updateThemeDisplay() { const s = themeOptions?.querySelector(`.option-item[data-theme="${currentTheme}"]`); if (s && currentThemeText && currentThemeSwatch) { const tK = s.querySelector('span:not(.theme-swatch)')?.dataset.langKey; if (tK) { currentThemeText.textContent = getText(tK); } else { currentThemeText.textContent = s.querySelector('span:not(.theme-swatch)')?.textContent || currentTheme; } const w = s.querySelector('.theme-swatch'); if (w) { currentThemeSwatch.style.background = w.style.background; currentThemeSwatch.className = 'theme-swatch'; const c = Array.from(w.classList).find(cls => cls !== 'theme-swatch'); if (c) { currentThemeSwatch.classList.add(c); } } themeOptions?.querySelectorAll('.option-item').forEach(i => { const a = i.dataset.theme === currentTheme; i.classList.toggle('active', a); i.setAttribute('aria-selected', a); }); } }
            // Update Discovery Mode Toggle Visuals
            function updateDiscoveryToggleVisualState() {
                if (discoveryModeToggle) {
                    discoveryModeToggle.setAttribute('aria-checked', isDiscoveryModeActivated);
                }
            }
            function updateSettingsDisplays() { updateLanguageDisplay(); updateThemeDisplay(); updateDiscoveryToggleVisualState(); }

            // Function to update visibility of Discover button on Screen 3
            function updateDiscoverButtonVisibility() {
                if (discoverButton) {
                    discoverButton.style.display = isDiscoveryModeActivated ? 'inline-flex' : 'none'; // Use inline-flex
                }
            }
            // --- End Settings Panel Logic ---

            // --- Language and UI Update Functions ---
            function updateLanguageUI() {
                 htmlElement.lang = currentLanguage;
                 document.querySelectorAll('[data-lang-key]').forEach(el => {
                     const key = el.dataset.langKey;
                     const translation = getText(key);
                     if (['welcome_title', 'admin_login_title'].includes(key)) { el.innerHTML = translation; }
                     else if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                         if (el.dataset.langValueTarget) { el.setAttribute(el.dataset.langValueTarget, translation); }
                     }
                     else { el.textContent = translation; }
                 });
                 document.querySelectorAll('[data-lang-placeholder-key]').forEach(el => {
                     const key = el.dataset.langPlaceholderKey;
                     if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                         el.placeholder = getText(key);
                     }
                 });
                 updateSettingsDisplays(); // Includes toggle state update
                 populateMenuGrid();
                 updateCartUI(); // Always redraw on language change for item names etc.
                 if (currentScreen && currentScreen.id === 'screen-5') { const logTitle = currentScreen.querySelector('.order-log-section h4'); const previewTitle = currentScreen.querySelector('.order-preview-section h4'); if(logTitle) logTitle.textContent = getText('order_log_title'); if(previewTitle) previewTitle.textContent = getText('order_preview_title'); renderOrderLog(); if (currentAdminOrderSelection) showOrderDetails(currentAdminOrderSelection); else clearOrderPreview(); }
                 if (currentScreen && currentScreen.id === 'screen-7') { const currentItemId = addToCartPreviewButton?.dataset.itemId; if (currentItemId) { showItemPreview(currentItemId, false); const isAdded = addToCartPreviewButton.classList.contains('added'); setPreviewButtonState(isAdded); } }
                 if (currentScreen && currentScreen.id === 'screen-8') { populateDiscoveryMode(); }
                 updateModalLanguage();
                 if (addToCartPreviewButton && addToCartPreviewButton.dataset.itemId) { const isAdded = addToCartPreviewButton.classList.contains('added'); setPreviewButtonState(isAdded); }
                if (currentScreen && currentScreen.id === 'screen-8') {
                    if(discoveryBundlesScroller) { discoveryBundlesScroller.querySelectorAll('.add-bundle-button.added span').forEach(span => { if(span) span.textContent = getText('bundle_added_button'); }); }
                    if(discoverySuggestionsGrid) { discoverySuggestionsGrid.querySelectorAll('.add-suggestion-button.added span').forEach(span => { if(span) span.textContent = getText('suggestion_added_button'); }); }
                 }
                 updatePasscodeModalLanguage(); // Update passcode modal text
                 updateDiscoverButtonVisibility(); // Update button visibility on lang change
             }

            // --- Screen Management ---
             function showScreen(id, skip = false) {
                 const targetScreen = document.getElementById(id);
                 if (targetScreen && targetScreen !== currentScreen) {
                     toggleSettingsPanel(false);
                     let fromScreenId = null;
                     if (currentScreen) {
                         fromScreenId = currentScreen.id;
                         currentScreen.classList.remove('active');
                         if (fromScreenId === 'screen-7') { resetPreviewButtonState(); }
                         if (fromScreenId === 'screen-8') { Object.values(suggestionButtonTimeouts).forEach(clearTimeout); Object.values(bundleButtonTimeouts).forEach(clearTimeout); suggestionButtonTimeouts = {}; bundleButtonTimeouts = {}; }
                     }
                     requestAnimationFrame(() => {
                         targetScreen.classList.add('active');
                         currentScreen = targetScreen;

                         // Store previous screen ID ONLY when navigating TO screen 7 from menu or discovery
                         if (id === 'screen-7' && fromScreenId && ['screen-3', 'screen-8'].includes(fromScreenId)) {
                             previousScreenId = fromScreenId;
                             console.log("Navigating to Screen 7 from:", previousScreenId);
                         } else if (id !== 'screen-7' && fromScreenId !== 'screen-7') {
                            // Reset only if navigating between non-preview related screens
                             previousScreenId = null;
                             console.log("Resetting previousScreenId (not navigating to/from preview)");
                         }

                         if (id === 'screen-4') updateCartUI();
                         if (id === 'screen-5') { renderOrderLog(); clearOrderPreview(); if(orderSearchInput) orderSearchInput.value = ''; }
                         if (id === 'screen-6') { if(adminLoginErrorMsg) adminLoginErrorMsg.style.display = 'none'; }
                         if (id === 'screen-3' || id === 'screen-7' || id === 'screen-8') updateCartBadge();
                         if (id === 'screen-8') { populateDiscoveryMode(); }
                         if (id === 'screen-3') { updateDiscoverButtonVisibility(); }
                         if (targetScreen && !skip) targetScreen.scrollTop = 0;
                     });
                 } else if (!targetScreen) {
                     console.error(`Screen ${id} not found`);
                 } else if (targetScreen === currentScreen && !skip) {
                     targetScreen.scrollTop = 0;
                     toggleSettingsPanel(false);
                 }
             }

            // --- User and Profile Functions ---
            function updateUserInfoUI() { if (currentUser) { const n = currentUser.email.split('@')[0]; if(userDisplayName) userDisplayName.textContent = `@${n}`; if(userProfileImage) { userProfileImage.src = currentUser.profilePic; userProfileImage.alt = `${n}'s PP`; userProfileImage.style.display = 'block'; } if(guestUserIcon) guestUserIcon.style.display = 'none'; } else { if(userDisplayName) userDisplayName.textContent = '@guest'; if(userProfileImage) { userProfileImage.src = ''; userProfileImage.alt = 'User Profile'; userProfileImage.style.display = 'none'; } if(guestUserIcon) guestUserIcon.style.display = 'block'; } }

            // --- Menu and Filtering Functions ---
            function populateMenuGrid() { if(!menuGrid || !menuSortButtonsContainer) return; menuGrid.innerHTML = ''; const a = menuSortButtonsContainer.querySelector('.sort-button.active'); let c = 'sweet'; if (a) c = a.dataset.category; else { const s = menuSortButtonsContainer.querySelector('[data-category="sweet"]'); if(s) s.classList.add('active'); } baseMenuData.forEach((item, i) => { const m = document.createElement('div'); m.className = 'menu-item'; m.dataset.id = item.id; m.dataset.category = item.category; const n = getText(item.name_key), p = formatPrice(item.price); m.innerHTML = `<img src="${item.image}" alt="${n}"><p>${n}</p><span class="price-button">${p}</span>`; if (item.category !== c) { m.classList.add('hidden'); m.style.animation = 'none'; } else m.style.animation = `fadeInItem 0.4s ${i * 0.04}s ease-out backwards`; menuGrid.appendChild(m); }); }
            function applyFilter(s, a = true) { if (!s || s.id !== 'screen-3') return; const m = s.querySelectorAll('.menu-grid .menu-item'), b = s.querySelector('.sort-buttons .sort-button.active'), c = b ? b.dataset.category : null; m.forEach((i, x) => { const v = !c || i.dataset.category === c; i.classList.toggle('hidden', !v); i.style.animation = (v && a) ? `fadeInItem 0.4s ${x * 0.04}s ease-out backwards` : 'none'; }); }

            // --- Cart Functions ---
            function updateCartBadge() { const totalQuantity = cart.reduce((sum, item) => sum + (item.isDiscount ? 0 : item.quantity), 0); [cartBadge, cartBadgePreview, cartBadgeDiscovery].forEach(badgeElement => { if (badgeElement) { badgeElement.textContent = totalQuantity; badgeElement.classList.toggle('visible', totalQuantity > 0); } }); }
            function updateCartUI() {
                if (!cartItemsContainer || !totalCalculationDetails || !checkoutButton) return;
                cartItemsContainer.innerHTML = '';
                totalCalculationDetails.innerHTML = '';
                let totalPriceBeforeDiscounts = 0;
                let totalDiscount = 0;
                const currencySymbol = getCurrency();
                const quantityPrefix = getText('quantity_prefix');

                if (cart.length === 0) {
                    cartItemsContainer.innerHTML = `<p class="empty-cart-message">${getText('cart_empty_message')}</p>`;
                } else {
                    cart.forEach(item => {
                        const itemSubtotal = item.price * item.quantity;
                        if (item.isDiscount) {
                            totalDiscount += Math.abs(itemSubtotal);
                            const discountName = getText(item.name_key) || "Discount";
                            totalCalculationDetails.innerHTML += `<p style="color: var(--active-green); font-weight: bold;">${discountName}: -${formatPrice(Math.abs(item.price))}</p>`;
                            const cartItemEl = document.createElement('div');
                            cartItemEl.className = 'cart-item discount-item';
                            cartItemEl.dataset.id = item.id;
                            cartItemEl.innerHTML = `
                                <img src="${item.image || 'https://img.icons8.com/ios-filled/50/discount--v1.png'}" alt="Discount" style="opacity:0.5; filter: grayscale(80%); width: 40px; height: 40px; object-fit: contain;">
                                <div class="item-details">
                                    <div class="item-info"><p>${discountName}</p></div>
                                    <span class="item-price-button" style="color: var(--active-green); font-weight: bold; background: transparent; border: none; padding: 6px 0;">-${formatPrice(Math.abs(item.price))}</span>
                                </div>
                                <button class="remove-item-button" title="Remove discount">&times;</button>`;
                            cartItemsContainer.appendChild(cartItemEl);
                        } else {
                            totalPriceBeforeDiscounts += itemSubtotal;
                            const itemName = getText(item.name_key);
                            totalCalculationDetails.innerHTML += `<p>${quantityPrefix}${item.quantity} ${itemName} = ${formatPrice(itemSubtotal)}</p>`;
                            const cartItemEl = document.createElement('div');
                            cartItemEl.className = 'cart-item';
                            cartItemEl.dataset.id = item.id;
                            cartItemEl.innerHTML = `
                                <img src="${item.image}" alt="${itemName}">
                                <div class="item-details">
                                    <div class="item-info"><p title="${itemName}">${itemName}</p><span class="item-quantity">${quantityPrefix}${item.quantity}</span></div>
                                    <span class="item-price-button">${formatPrice(itemSubtotal)}</span>
                                </div>
                                <button class="remove-item-button" title="Remove item">&times;</button>`;
                            cartItemsContainer.appendChild(cartItemEl);
                        }
                    });
                }

                const finalTotal = totalPriceBeforeDiscounts - totalDiscount;
                checkoutButton.textContent = formatPrice(finalTotal);
                checkoutButton.disabled = cart.filter(item => !item.isDiscount).length === 0;
                updateCartBadge();
            }
            function addToCart(id) { const d = baseMenuData.find(i => i.id === id); if (!d) return; const e = cart.find(i => i.id === id && !i.isDiscount); if (e) e.quantity++; else cart.push({ ...d, quantity: 1 }); updateCartUI(); }
            function removeFromCart(id) { const itemIndex = cart.findIndex(i => i.id === id); if (itemIndex === -1) return; if (cart[itemIndex].isDiscount || cart[itemIndex].quantity <= 1) { cart.splice(itemIndex, 1); } else { cart[itemIndex].quantity--; } updateCartUI(); }

            // --- Item Preview Functions ---
            function showItemPreview(id, n = true) { const d = baseMenuData.find(i => i.id === id); if (!d || !previewItemImage || !previewItemName || !previewItemDescription || !previewItemPrice || !addToCartPreviewButton) return; const nm = getText(d.name_key), ds = getText(d.description_key || 'item_desc_default'), p = formatPrice(d.price); previewItemImage.src = d.image; previewItemImage.alt = nm; previewItemName.textContent = nm; previewItemDescription.textContent = ds; previewItemPrice.textContent = p; addToCartPreviewButton.dataset.itemId = id; setPreviewButtonState(false); if (n) showScreen('screen-7'); else updateCartBadge(); }
            function setPreviewButtonState(a) { if (!addToCartPreviewButton) return; addToCartPreviewButton.classList.toggle('added', a); const k = a ? 'added_to_cart_button' : 'add_to_cart_button'; const c = a ? 'fas fa-check' : 'fas fa-cart-plus'; let s = addToCartPreviewButton.querySelector('span'); if (!s) { s = document.createElement('span'); addToCartPreviewButton.appendChild(s); } s.dataset.langKey = k; s.textContent = getText(k); let i = addToCartPreviewButton.querySelector('i'); if (!i) { i = document.createElement('i'); addToCartPreviewButton.prepend(i); } i.className = c; i.style.marginRight = ''; i.style.marginLeft = ''; }
            function resetPreviewButtonState() { if(addToCartPreviewButton) { if (previewButtonTimeout) { clearTimeout(previewButtonTimeout); previewButtonTimeout = null; } setPreviewButtonState(false); addToCartPreviewButton.dataset.itemId = ''; } }

            // --- Order Placement and Management Functions ---
             function generateOrderId() { return `ORD-${Date.now()}-${Math.floor(Math.random()*10)}`; }
             function placeOrder() { const actualItems = cart.filter(item => !item.isDiscount); if (actualItems.length === 0) { showCustomAlert(getText('cart_is_empty_alert')); return; } const finalTotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0); const o = { id: generateOrderId(), items: cart.map(i => ({ id: i.id, name_key: i.name_key, price: i.price, quantity: i.quantity, isDiscount: i.isDiscount || false })), totalAmount: finalTotal, timestamp: new Date(), status: 'pending', paymentMethod: selectedPaymentMethod }; allOrders.push(o); console.log("Order Placed:", o); cart = []; selectedPaymentMethod = 'cash'; updateCartUI(); if (paymentMethodsContainer) paymentMethodsContainer.querySelectorAll('.payment-button').forEach(b => b.classList.toggle('active', b.dataset.method === 'cash')); const m = getText('checkout_success_alert').replace('{method}', getText(`payment_${o.paymentMethod}`)).replace('{id}', o.id).replace('{total}', formatPrice(o.totalAmount)); showCustomAlert(m); }
             function renderOrderLog(f = allOrders) { if(!orderLogContainer) return; orderLogContainer.innerHTML = ''; const s = [...f].sort((a, b) => b.timestamp - a.timestamp), c = getCurrency(); if (s.length === 0) { orderLogContainer.innerHTML = `<p class="no-orders-message">${getText('no_orders_found')}</p>`; return; } s.forEach(o => { const l = document.createElement('div'); l.className = 'order-log-item'; l.dataset.orderId = o.id; const t = getText(`order_status_${o.status}`); l.innerHTML = `<span class="order-id" title="${o.id}">${o.id}</span><span class="order-status ${o.status}">${t}</span><span class="order-total">${o.totalAmount} ${c}</span>`; l.classList.toggle('active', o.id === currentAdminOrderSelection); l.addEventListener('click', () => { currentAdminOrderSelection = o.id; showOrderDetails(o.id); renderOrderLog(f); }); orderLogContainer.appendChild(l); }); }
             function clearOrderPreview() { if(!orderPreviewContent || !orderStatusControls) return; orderPreviewContent.innerHTML = `<p class="order-preview-placeholder">${getText('order_preview_placeholder')}</p>`; orderStatusControls.innerHTML = ''; currentAdminOrderSelection = null; orderLogContainer?.querySelectorAll('.order-log-item.active').forEach(i => i.classList.remove('active')); }
             function showOrderDetails(id) {
                const o = allOrders.find(ord => ord.id === id);
                if (!o || !orderPreviewContent) { clearOrderPreview(); return; }
                const c = getCurrency(),
                      l = currentLanguage === 'ar' ? 'ar-EG' : 'en-GB',
                      ft = o.timestamp.toLocaleString(l, { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false }), // Use 24hr format maybe
                      tst = getText(`order_status_${o.status}`),
                      tp = getText(`payment_${o.paymentMethod}`);

                let ih = '<ul>';
                let originalSubTotal = 0;
                let hasDiscount = false;
                o.items.forEach(i => {
                    const n = getText(i.name_key);
                    if (i.isDiscount) {
                        ih += `<li style="color: var(--active-green);"><em>${n}: -${formatPrice(Math.abs(i.price))}</em></li>`;
                        hasDiscount = true;
                    } else {
                        ih += `<li>${getText('quantity_prefix')}${i.quantity} ${n} (${formatPrice(i.price * i.quantity)})</li>`;
                        originalSubTotal += i.price * i.quantity;
                    }
                });
                ih += '</ul>';

                let subtotalHtml = '';
                 if (hasDiscount && originalSubTotal > 0) { // Display subtotal only if there was a discount
                     // Use translation key here
                     subtotalHtml = `<p><strong>${getText('subtotal_label')}:</strong> <span style="text-decoration: line-through;">${formatPrice(originalSubTotal)}</span></p>`;
                 }

                orderPreviewContent.innerHTML = `
                    <p><strong>${getText('order_id_label')}:</strong> <span>${o.id}</span></p>
                    <p><strong>${getText('order_placed_label')}:</strong> <span>${ft}</span></p>
                    <p><strong>${getText('order_status_label')}:</strong><span style="text-transform:capitalize;font-weight:bold;"> ${tst}</span></p>
                    <p><strong>${getText('order_payment_label')}:</strong><span style="text-transform:capitalize;"> ${tp}</span></p>
                    ${subtotalHtml}
                    <p><strong>${getText('order_total_label')}:</strong> <span>${formatPrice(o.totalAmount)}</span></p>
                    <p><strong>${getText('order_items_label')}:</strong></p>${ih}`;
                renderStatusButtons(o);
            }
             function renderStatusButtons(o) { if(!orderStatusControls) return; orderStatusControls.innerHTML = ''; const p = ['pending', 'preparing', 'delivered']; p.forEach(s => { const b = document.createElement('button'); b.className = 'button small-button status-button'; b.dataset.status = s; const t = getText(`order_status_${s}`); b.textContent = t.charAt(0).toUpperCase() + t.slice(1); b.disabled = (o.status === s); b.classList.toggle('active', o.status === s); let ic = ''; if (s === 'pending') ic = 'fas fa-hourglass-start'; else if (s === 'preparing') ic = 'fas fa-cogs'; else if (s === 'delivered') ic = 'fas fa-check-circle'; if(ic) { const i = document.createElement('i'); i.className = ic; b.prepend(i, ' '); } b.addEventListener('click', () => updateOrderStatus(o.id, s)); orderStatusControls.appendChild(b); }); }
             function updateOrderStatus(id, n) { const i = allOrders.findIndex(o => o.id === id); if (i === -1) return; allOrders[i].status = n; console.log(`Order ${id} status -> ${n}`); handleOrderSearch(); }
             function handleOrderSearch() { if(!orderSearchInput) return; const s = orderSearchInput.value.trim().toLowerCase(), o = s ? allOrders.filter(ord => ord.id.toLowerCase().includes(s)) : allOrders; renderOrderLog(o); if (currentAdminOrderSelection && o.some(ord => ord.id === currentAdminOrderSelection)) showOrderDetails(currentAdminOrderSelection); else clearOrderPreview(); }

            // --- Discovery Mode Functions ---
            function populateDiscoveryMode() {
                if (!discoveryBundlesScroller || !discoverySuggestionsGrid || !discoveryCategoriesContainer) return;
                discoveryBundlesScroller.innerHTML = '';
                discoverySuggestionsGrid.innerHTML = '';
                discoveryCategoriesContainer.innerHTML = '';
                const MAX_IMAGES_SHOWN = 4; // For bundles

                // Bundles
                bundleOffers.forEach(bundle => { const card = document.createElement('div'); card.className = 'offer-card bundle-offer'; card.dataset.bundleId = bundle.id; const bundleName = getText(bundle.name_key); const bundleDesc = getText(bundle.description_key); let itemsHtml = `<p class="offer-items"><strong>${getText('includes_items')}</strong> `; let imageGridHtml = ''; let originalTotalPrice = 0; let allItemsFound = true; let imageCount = 0; bundle.itemIds.forEach(itemId => { const itemData = baseMenuData.find(i => i.id === itemId); if (itemData) { itemsHtml += `<span>${getText(itemData.name_key)}</span>`; originalTotalPrice += itemData.price; if (imageCount < MAX_IMAGES_SHOWN) { imageGridHtml += `<img src="${itemData.image}" alt="${getText(itemData.name_key)}">`; imageCount++; } } else { allItemsFound = false; console.warn(`Item ${itemId} not found for bundle ${bundle.id}`); } }); itemsHtml += '</p>'; let gridClass = 'offer-image-grid'; if (imageCount === 1) gridClass += ' count-1'; else if (imageCount === 3) gridClass += ' count-3'; const imageGridContainer = `<div class="${gridClass}">${imageGridHtml}</div>`; if (allItemsFound && originalTotalPrice > 0) { const discountMultiplier = (100 - bundle.discountPercent) / 100; const finalPrice = Math.round(originalTotalPrice * discountMultiplier); const discountTag = `<span class="bundle-discount-tag">${getText('discount_tag').replace('{percent}', bundle.discountPercent)}</span>`; card.innerHTML = ` ${discountTag} <h5>${bundleName}</h5> ${imageCount > 0 ? imageGridContainer : ''} <p class="offer-description">${bundleDesc}</p> ${itemsHtml} <div class="offer-actions"> <div class="bundle-pricing"> <span class="bundle-original-price">${getText('original_price')} ${formatPrice(originalTotalPrice)}</span> <span class="bundle-final-price">${getText('bundle_price')} ${formatPrice(finalPrice)}</span> </div> <button class="button rect-button add-bundle-button"> <i class="fas fa-cart-plus"></i> <span data-lang-key="add_bundle_button">${getText('add_bundle_button')}</span> </button> </div>`; discoveryBundlesScroller.appendChild(card); } });

                // Meal Ideas (Suggestions)
                mealSuggestions.forEach(suggestion => {
                    const gridItem = document.createElement('div');
                    gridItem.className = 'suggestion-grid-item';
                    gridItem.dataset.suggestionId = suggestion.id;
                    const suggName = getText(suggestion.name_key);
                    let itemsHtml = `<div class="suggestion-items">`; // Text list of items
                    let itemImagesHtml = ''; // Image row HTML
                    let allItemsFound = true;
                    let suggestionTotalPrice = 0;

                    suggestion.itemIds.forEach((itemId, index) => {
                        const itemData = baseMenuData.find(i => i.id === itemId);
                        if (itemData) {
                            itemsHtml += `<span>${getText(itemData.name_key)}</span>`;
                            suggestionTotalPrice += itemData.price;
                            // Add image to the image row
                            itemImagesHtml += `<img src="${itemData.image}" alt="${getText(itemData.name_key)}" title="${getText(itemData.name_key)}">`;
                            // Add plus separator if not the last item
                            if (index < suggestion.itemIds.length - 1) {
                                itemImagesHtml += ` <span class="plus-separator">+</span> `;
                            }
                        } else {
                            allItemsFound = false;
                            console.warn(`Item ${itemId} not found for suggestion ${suggestion.id}`);
                        }
                    });
                    itemsHtml += '</div>'; // Close text list

                    const itemImagesContainer = `<div class="suggestion-item-images">${itemImagesHtml}</div>`;
                    const totalPriceHtml = `<p class="suggestion-total-price"><strong>${getText('suggestion_total_price')}</strong> ${formatPrice(suggestionTotalPrice)}</p>`;

                    if (allItemsFound) {
                        const buttonHtml = ` <button class="button rect-button add-suggestion-button"> <i class="fas fa-cart-plus"></i> <span data-lang-key="add_suggestion_button">${getText('add_suggestion_button')}</span> </button>`;
                        // Assemble the grid item HTML - Replace icon with image container
                        gridItem.innerHTML = `
                            ${itemImagesContainer}
                            <h5>${suggName}</h5>
                            ${itemsHtml}
                            ${totalPriceHtml}
                            ${buttonHtml}
                        `;
                        discoverySuggestionsGrid.appendChild(gridItem);
                    }
                });

                // Categories
                const categories = [...new Set(baseMenuData.map(item => item.category))]; categories.forEach(category => { const categorySection = document.createElement('div'); categorySection.className = 'discovery-category-section'; const categoryTitle = document.createElement('h5'); const categoryTitleKey = `sort_${category.toLowerCase()}`; categoryTitle.textContent = getText(categoryTitleKey) || category.charAt(0).toUpperCase() + category.slice(1); categorySection.appendChild(categoryTitle); const categoryGrid = document.createElement('div'); categoryGrid.className = 'discovery-category-grid'; const categoryItems = baseMenuData.filter(item => item.category === category); categoryItems.forEach(item => { const itemEl = document.createElement('div'); itemEl.className = 'discovery-category-item'; itemEl.dataset.id = item.id; const itemName = getText(item.name_key); const itemPrice = formatPrice(item.price); itemEl.innerHTML = ` <img src="${item.image}" alt="${itemName}"> <p title="${itemName}">${itemName}</p> <span class="price-button">${itemPrice}</span> `; itemEl.addEventListener('click', (e) => { if (!e.target.classList.contains('price-button')) { showItemPreview(item.id); } }); const priceButton = itemEl.querySelector('.price-button'); if (priceButton) { priceButton.addEventListener('click', (e) => { e.stopPropagation(); addToCart(item.id); priceButton.style.transition = 'transform 0.1s ease-out, background-color 0.1s ease-out'; priceButton.style.backgroundColor = 'var(--active-green)'; priceButton.style.transform = 'scale(1.1)'; setTimeout(() => { priceButton.style.backgroundColor = ''; priceButton.style.transform = ''; setTimeout(() => priceButton.style.transition = '', 150); }, 150); }); } categoryGrid.appendChild(itemEl); }); categorySection.appendChild(categoryGrid); discoveryCategoriesContainer.appendChild(categorySection); }); updateCartBadge();
            }
            function addSuggestionToCart(suggestionId, buttonElement) { /* ... (same as before) ... */ const suggestion = mealSuggestions.find(s => s.id === suggestionId); if (!suggestion || !buttonElement) return; suggestion.itemIds.forEach(itemId => { const itemExists = cart.find(i => i.id === itemId && !i.isDiscount); if (itemExists) { itemExists.quantity++; } else { const itemData = baseMenuData.find(i => i.id === itemId); if (itemData) { cart.push({ ...itemData, quantity: 1 }); } } }); updateCartUI(); if (suggestionButtonTimeouts[suggestionId]) { clearTimeout(suggestionButtonTimeouts[suggestionId]); } buttonElement.classList.add('added'); const icon = buttonElement.querySelector('i'); const span = buttonElement.querySelector('span'); if (icon) icon.className = 'fas fa-check'; if (span) { span.dataset.langKey = 'suggestion_added_button'; span.textContent = getText('suggestion_added_button'); } suggestionButtonTimeouts[suggestionId] = setTimeout(() => { if (buttonElement && buttonElement.classList.contains('added')) { buttonElement.classList.remove('added'); if (icon) icon.className = 'fas fa-cart-plus'; if (span) { span.dataset.langKey = 'add_suggestion_button'; span.textContent = getText('add_suggestion_button'); } } delete suggestionButtonTimeouts[suggestionId]; }, 1500); }
            function addBundleToCart(bundleId, buttonElement) { /* ... (same as before) ... */ const bundle = bundleOffers.find(b => b.id === bundleId); if (!bundle || !buttonElement) return; let originalTotalPrice = 0; let allItemsValid = true; bundle.itemIds.forEach(itemId => { const itemData = baseMenuData.find(i => i.id === itemId); if(itemData) { originalTotalPrice += itemData.price; const itemExists = cart.find(cartItem => cartItem.id === itemId && !cartItem.isDiscount); if (itemExists) { itemExists.quantity++; } else { cart.push({ ...itemData, quantity: 1 }); } } else { allItemsValid = false; console.warn(`Item ${itemId} missing for bundle ${bundleId}`); } }); if (!allItemsValid) return; const discountMultiplier = (100 - bundle.discountPercent) / 100; const finalPrice = Math.round(originalTotalPrice * discountMultiplier); const discountAmount = originalTotalPrice - finalPrice; if (discountAmount > 0) { const discountItemId = `discount-${bundleId}-${Date.now()}`; const discountItem = { id: discountItemId, name_key: 'bundle_discount_applied', price: -discountAmount, quantity: 1, isDiscount: true, image: 'https://img.icons8.com/ios-filled/50/discount--v1.png' }; cart.push(discountItem); console.log(`Applied discount: ${discountAmount} for bundle ${bundleId}`); } updateCartUI(); if (bundleButtonTimeouts[bundleId]) { clearTimeout(bundleButtonTimeouts[bundleId]); } buttonElement.classList.add('added'); const icon = buttonElement.querySelector('i'); const span = buttonElement.querySelector('span'); if (icon) icon.className = 'fas fa-check'; if (span) { span.dataset.langKey = 'bundle_added_button'; span.textContent = getText('bundle_added_button'); } bundleButtonTimeouts[bundleId] = setTimeout(() => { if (buttonElement && buttonElement.classList.contains('added')) { buttonElement.classList.remove('added'); if (icon) icon.className = 'fas fa-cart-plus'; if (span) { span.dataset.langKey = 'add_bundle_button'; span.textContent = getText('add_bundle_button'); } } delete bundleButtonTimeouts[bundleId]; }, 1500); }
            // --- End Discovery Mode Functions ---

            // --- Custom Alert Functions ---
            function updateModalLanguage() { if (customAlertTitle) { const titleKey = customAlertTitle.dataset.langKey || 'checkout_success_title'; customAlertTitle.textContent = getText(titleKey); } if (customAlertCloseBtn) customAlertCloseBtn.textContent = getText('ok_button'); }
            function showCustomAlert(m, titleKey = 'checkout_success_title') { if (!customAlertOverlay || !customAlertMessage) return; if(customAlertTitle) customAlertTitle.dataset.langKey = titleKey; updateModalLanguage(); customAlertMessage.textContent = m; requestAnimationFrame(() => { customAlertOverlay.classList.add('visible'); }); }
            function hideCustomAlert() {
                if (!customAlertOverlay || !customAlertOverlay.classList.contains('visible')) return;
                const msg = customAlertMessage?.textContent; // Get message before hiding
                customAlertOverlay.classList.remove('visible');
                const isCartEmptyAlert = msg === getText('cart_is_empty_alert');
                // Navigate back only if it wasn't an empty cart alert
                if(currentScreen?.id !== 'screen-3' && !isCartEmptyAlert){
                    showScreen('screen-3');
                }
            }
            // --- End Custom Alert Functions ---

            // --- Passcode Modal Functions ---
            function updatePasscodeModalLanguage() {
                if(passcodeModalTitle) passcodeModalTitle.textContent = getText('discovery_passcode_modal_title');
                if(passcodeModalInput) passcodeModalInput.placeholder = getText('discovery_passcode_prompt');
                if(passcodeModalError) passcodeModalError.textContent = getText('discovery_passcode_incorrect_message'); // Set text even if hidden
                if(passcodeModalOk) passcodeModalOk.textContent = getText('ok_button');
                if(passcodeModalCancel) passcodeModalCancel.textContent = getText('cancel_button'); // Changed key
            }
            function showPasscodeModal() {
                if (!passcodeModalOverlay) return;
                updatePasscodeModalLanguage();
                if(passcodeModalInput) passcodeModalInput.value = '';
                if(passcodeModalError) passcodeModalError.style.display = 'none';
                requestAnimationFrame(() => {
                    passcodeModalOverlay.classList.add('visible');
                    if(passcodeModalInput) passcodeModalInput.focus();
                });
            }
            function hidePasscodeModal() {
                if (!passcodeModalOverlay) return;
                passcodeModalOverlay.classList.remove('visible');
            }
            function handlePasscodeSubmit() {
                const enteredPasscode = passcodeModalInput?.value;
                if (enteredPasscode === DISCOVERY_PASSCODE) {
                    isDiscoveryModeActivated = true;
                    localStorage.setItem('discoveryModeActivated', isDiscoveryModeActivated);
                    updateDiscoveryToggleVisualState();
                    updateDiscoverButtonVisibility();
                    hidePasscodeModal();
                } else {
                    if (passcodeModalError) passcodeModalError.style.display = 'block';
                    if (passcodeModalInput) passcodeModalInput.value = '';
                    console.warn("Incorrect passcode entered");
                }
            }
            // --- End Passcode Modal Functions ---


            // --- Event Listeners ---
            // General Navigation (using data-target)
             navigationElements.forEach(e => {
                 const targetId = e.dataset.target;
                 // Exclude the preview back button from this generic handler
                 if (targetId && e.id !== 'item-preview-back-button') {
                     e.addEventListener('click', () => showScreen(targetId));
                 }
             });

            loginSubmitButton?.addEventListener('click', () => { const e = loginEmailInput.value.trim(), p = loginPasswordInput.value; if(!loginErrorMsg) return; loginErrorMsg.style.display = 'none'; if (e && p) { currentUser = { email: e, profilePic: DEFAULT_PROFILE_PIC }; loginEmailInput.value = ''; loginPasswordInput.value = ''; updateUserInfoUI(); showScreen('screen-3'); } else { loginErrorMsg.textContent = getText('login_error_fields'); loginErrorMsg.style.display = 'block'; } });
            gotoAdminLoginButton?.addEventListener('click', () => showScreen('screen-6'));
            registerSubmitButton?.addEventListener('click', () => { const e = registerEmailInput.value.trim(), p = registerPasswordInput.value, c = registerPasswordConfirmInput.value, a = registerPhotoPicker?.querySelector('.profile-pic.active'); if(!registerErrorMsg) return; registerErrorMsg.style.display = 'none'; if (!e || !p || !c) { registerErrorMsg.textContent = getText('register_error_fields'); registerErrorMsg.style.display = 'block'; return; } if (p !== c) { registerErrorMsg.textContent = getText('register_error_match'); registerErrorMsg.style.display = 'block'; return; } if (!a) { registerErrorMsg.textContent = getText('register_error_photo'); registerErrorMsg.style.display = 'block'; return; } currentUser = { email: e, profilePic: a.src }; registerEmailInput.value = ''; registerPasswordInput.value = ''; registerPasswordConfirmInput.value = ''; updateUserInfoUI(); showScreen('screen-3'); });
            registerPhotoPicker?.addEventListener('click', e => { if (e.target.classList.contains('profile-pic')) { registerPhotoPicker.querySelectorAll('.profile-pic').forEach(p => p.classList.remove('active')); e.target.classList.add('active'); } });
            logoutButton?.addEventListener('click', () => { currentUser = null; cart = []; selectedPaymentMethod = 'cash'; updateCartUI(); updateUserInfoUI(); if(paymentMethodsContainer) paymentMethodsContainer.querySelectorAll('.payment-button').forEach(b => b.classList.toggle('active', b.dataset.method === 'cash')); if (menuSortButtonsContainer) { const d = baseMenuData[0]?.category || 'sweet'; menuSortButtonsContainer.querySelectorAll('.sort-button').forEach(b => b.classList.toggle('active', b.dataset.category === d)); populateMenuGrid(); } isDiscoveryModeActivated = false; localStorage.removeItem('discoveryModeActivated'); updateDiscoverButtonVisibility(); updateDiscoveryToggleVisualState(); /* Added toggle update */ showScreen('screen-1'); });
            menuGrid?.addEventListener('click', e => { const m = e.target.closest('.menu-item'), p = e.target.closest('.price-button'); if (m) { const id = m.dataset.id; if (p) { addToCart(id); p.style.transition = 'transform 0.1s ease-out, background-color 0.1s ease-out'; p.style.backgroundColor = 'var(--active-green)'; p.style.transform = 'scale(1.1)'; setTimeout(() => { p.style.backgroundColor = ''; p.style.transform = ''; setTimeout(() => p.style.transition = '', 150); }, 150); } else { showItemPreview(id); } } });
            menuSortButtonsContainer?.addEventListener('click', e => { if (e.target.classList.contains('sort-button')) { const b = e.target; if (b.classList.contains('active')) return; menuSortButtonsContainer.querySelectorAll('.sort-button').forEach(btn => btn.classList.remove('active')); b.classList.add('active'); applyFilter(document.getElementById('screen-3'), true); } });
            paymentMethodsContainer?.addEventListener('click', e => { const b = e.target.closest('.payment-button'); if (b && !b.classList.contains('active')) { selectedPaymentMethod = b.dataset.method; paymentMethodsContainer.querySelectorAll('.payment-button').forEach(btn => btn.classList.remove('active')); b.classList.add('active'); } });
            cartItemsContainer?.addEventListener('click', e => { if (e.target.classList.contains('remove-item-button')) { const c = e.target.closest('.cart-item'), id = c?.dataset.id; if (id) removeFromCart(id); } });
            checkoutButton?.addEventListener('click', () => { placeOrder(); });
            adminLoginSubmitButton?.addEventListener('click', () => { const e = adminEmailInput.value, p = adminPasswordInput.value; if(!adminLoginErrorMsg) return; adminLoginErrorMsg.style.display = 'none'; if (e === ADMIN_EMAIL && p === ADMIN_PASSWORD) { console.log("Admin login OK"); showScreen('screen-5'); } else { console.log("Admin login FAIL"); adminLoginErrorMsg.textContent = getText('admin_login_error'); adminLoginErrorMsg.style.display = 'block'; } });
            mgmtBackToLoginButton?.addEventListener('click', () => { clearOrderPreview(); if(orderSearchInput) orderSearchInput.value = ''; showScreen('screen-1'); });
            orderSearchButton?.addEventListener('click', handleOrderSearch);
            orderSearchInput?.addEventListener('keypress', e => { if (e.key === 'Enter') handleOrderSearch(); });
            orderSearchInput?.addEventListener('input', () => { if (orderSearchInput.value.trim() === '') handleOrderSearch(); });

            // Item Preview Back Button Listener
            itemPreviewBackButton?.addEventListener('click', () => {
                 const targetScreenId = previousScreenId || 'screen-3'; // Default back to menu
                 console.log("Going back to:", targetScreenId);
                 showScreen(targetScreenId);
                 // Reset previousScreenId AFTER navigating back
                 previousScreenId = null;
             });

            addToCartPreviewButton?.addEventListener('click', e => { const b = e.target.closest('button'), id = b?.dataset.itemId; if (id) { addToCart(id); if (previewButtonTimeout) { clearTimeout(previewButtonTimeout); } setPreviewButtonState(true); previewButtonTimeout = setTimeout(() => { if (currentScreen && currentScreen.id === 'screen-7' && addToCartPreviewButton.dataset.itemId === id) { setPreviewButtonState(false); } previewButtonTimeout = null; }, 1500); } });
            toggleFullScreenButton?.addEventListener('click', () => { bodyElement.classList.toggle('full-screen-mode'); const f = bodyElement.classList.contains('full-screen-mode'); toggleFullScreenButton.innerHTML = f ? '<i class="fas fa-compress"></i>' : '<i class="fas fa-expand"></i>'; toggleFullScreenButton.title = f ? 'Exit Full Screen' : 'Enter Full Screen'; });

            // Listener for Discover button (navigates if activated)
             discoverButton?.addEventListener('click', () => {
                 if (isDiscoveryModeActivated) {
                     showScreen('screen-8');
                 } else {
                     console.warn("Discover button clicked but Discovery Mode is not activated.");
                 }
             });

             // Event delegation for Discovery Screen
            discoveryBundlesScroller?.addEventListener('click', (e) => { const bundleButton = e.target.closest('.add-bundle-button'); if (bundleButton) { const card = bundleButton.closest('.offer-card'); const bundleId = card?.dataset.bundleId; if (bundleId) { addBundleToCart(bundleId, bundleButton); } } });
            discoverySuggestionsGrid?.addEventListener('click', (e) => { const suggestionButton = e.target.closest('.add-suggestion-button'); if (suggestionButton) { const card = suggestionButton.closest('.suggestion-grid-item'); const suggestionId = card?.dataset.suggestionId; if (suggestionId) { addSuggestionToCart(suggestionId, suggestionButton); } } });
            discoveryCategoriesContainer?.addEventListener('click', e => { const categoryItem = e.target.closest('.discovery-category-item'); const priceButton = e.target.closest('.price-button'); if (categoryItem && !priceButton) { const itemId = categoryItem.dataset.id; if(itemId) { showItemPreview(itemId); } } });

            // --- Settings Panel Event Listeners ---
             if (settingsBtn) { settingsBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleSettingsPanel(); }); }
            if (currentLanguageDisplay) { currentLanguageDisplay.addEventListener('click', (e) => { e.stopPropagation(); toggleSettingsDropdown(languageGroup); }); currentLanguageDisplay.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleSettingsDropdown(languageGroup); } }); }
            if (currentThemeDisplay) { currentThemeDisplay.addEventListener('click', (e) => { e.stopPropagation(); toggleSettingsDropdown(themeGroup); }); currentThemeDisplay.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleSettingsDropdown(themeGroup); } }); }
            if (languageOptions) { languageOptions.addEventListener('click', (e) => { const o = e.target.closest('.option-item[data-lang]'); if (o && !o.classList.contains('active')) { const n = o.dataset.lang; appContainer.classList.add('language-switching'); setTimeout(() => { currentLanguage = n; localStorage.setItem('appLanguage', currentLanguage); updateLanguageUI(); closeAllSettingsDropdowns(); requestAnimationFrame(() => { appContainer.classList.remove('language-switching'); }); }, parseFloat(getComputedStyle(appContainer).getPropertyValue('--lang-change-speed') || '0.3') * 1000); } else if (o) { closeAllSettingsDropdowns(); } }); }
            if (themeOptions) { themeOptions.addEventListener('click', (e) => { const o = e.target.closest('.option-item[data-theme]'); if (o && !o.classList.contains('active')) { const n = o.dataset.theme; applyTheme(n); updateThemeDisplay(); closeAllSettingsDropdowns(); } else if (o) { closeAllSettingsDropdowns(); } }); }

             // MODIFIED: Add Passcode check for Discovery Mode Toggle
            if (discoveryModeToggle) {
                const toggleAction = () => {
                    if (isDiscoveryModeActivated) {
                        // Currently ON, turn OFF (no passcode needed)
                        isDiscoveryModeActivated = false;
                        localStorage.setItem('discoveryModeActivated', isDiscoveryModeActivated);
                        updateDiscoveryToggleVisualState();
                        updateDiscoverButtonVisibility();
                    } else {
                        // Currently OFF, show modal to turn ON
                        showPasscodeModal();
                    }
                 };
                 discoveryModeToggle.addEventListener('click', toggleAction);
                 discoveryModeToggle.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                         e.preventDefault();
                         toggleAction();
                    }
                 });
             }

            // --- End Settings Panel Event Listeners ---

            // --- Custom Alert Event Listeners ---
            customAlertCloseBtn?.addEventListener('click', hideCustomAlert);
            customAlertOverlay?.addEventListener('click', (e) => { if (e.target === customAlertOverlay) { hideCustomAlert(); } });
            // --- Passcode Modal Event Listeners (Updated IDs & Logic) ---
            passcodeModalOk?.addEventListener('click', handlePasscodeSubmit);
            passcodeModalCancel?.addEventListener('click', hidePasscodeModal);
            passcodeModalOverlay?.addEventListener('click', (e) => { if (e.target === passcodeModalOverlay) { hidePasscodeModal(); } });
            passcodeModalInput?.addEventListener('keypress', (e) => { if (e.key === 'Enter') { handlePasscodeSubmit(); } });
            // --- End Passcode Modal Event Listeners ---

            // --- Initialization ---
            applyTheme(currentTheme);
            updateLanguageUI(); // Includes updates for settings and discover button
            showScreen('screen-1');
            updateCartUI();
            updateUserInfoUI();
            // Initial visibility checks
            updateDiscoverButtonVisibility();
            updateDiscoveryToggleVisualState(); // Set toggle based on saved state
        });
    </script>

</body>
</html>
